<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å—¯é›åˆ€ç›¤é»å«è²¨ç³»çµ±</title>

  <!-- UI / React -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase (CDN compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f8fafc;
      color: #334155;
    }
    .compact-input {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      width: 100%;
      outline: none;
    }
  </style>
</head>

<body>
<div id="root"></div>

<!-- Firebase init -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
    authDomain: "order-718b1.firebaseapp.com",
    projectId: "order-718b1",
    storageBucket: "order-718b1.firebasestorage.app",
    messagingSenderId: "454465000018",
    appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
    measurementId: "G-3MC1RTW85K"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  const db = firebase.firestore();
</script>

<!-- React App -->
<script type="text/babel">
const { useState, useEffect, useMemo } = React;

const LucideIcon = ({ name, size = 18, className = "" }) => {
  useEffect(() => {
    if (window.lucide) window.lucide.createIcons();
  }, [name]);
  return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
};

const App = () => {
  const [view, setView] = useState("inventory");
  const [dayMode, setDayMode] = useState("weekday");
  const [items, setItems] = useState([]);

  const collectionRef = db.collection("order_items");

  // ğŸ”¥ Firestore å³æ™‚åŒæ­¥
  useEffect(() => {
    const unsub = collectionRef.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setItems(data);
    });
    return () => unsub();
  }, []);

  const updateItem = (id, field, value) => {
    collectionRef.doc(id).update({ [field]: value });
  };

  const addItem = () => {
    collectionRef.add({
      name: "æ–°éœ€æ±‚å“é …",
      unit: "ä»¶",
      weekdayTarget: 0,
      weekendTarget: 0,
      roundUp: false,
      currentStock: 0
    });
  };

  const deleteItem = (id) => {
    if (confirm("ç¢ºå®šåˆªé™¤æ­¤å“é …ï¼Ÿ")) {
      collectionRef.doc(id).delete();
    }
  };

  const calculateOrder = (item) => {
    const target = dayMode === "weekday" ? item.weekdayTarget : item.weekendTarget;
    let need = target - item.currentStock;
    if (need < 0) need = 0;
    return item.roundUp ? Math.ceil(need) : need;
  };

  const summaryText = useMemo(() => {
    const list = items
      .map(i => ({ ...i, orderQty: calculateOrder(i) }))
      .filter(i => i.orderQty > 0);

    if (list.length === 0) return "ç›®å‰ç„¡é ˆå«è²¨ã€‚";

    const date = new Date().toLocaleDateString();
    const mode = dayMode === "weekday" ? "å¹³æ—¥" : "å‡æ—¥";
    let txt = `ã€å«è²¨æ¸…å–® ${date} (${mode})ã€‘\n`;
    list.forEach(i => {
      txt += `â€¢ ${i.name}: ${i.orderQty} ${i.unit}\n`;
    });
    return txt;
  }, [items, dayMode]);

  const copyToClipboard = () => {
    navigator.clipboard.writeText(summaryText);
    alert("å·²è¤‡è£½å«è²¨æ¸…å–®ï¼");
  };

  return (
    <div className="max-w-2xl mx-auto min-h-screen flex flex-col">
      <header className="bg-white border-b px-4 py-3 flex justify-between items-center">
        <h1 className="font-black text-lg">ç›¤é»å«è²¨è¡¨</h1>
        <div className="flex gap-2">
          <button onClick={() => setView("inventory")} className="font-bold">ç›¤é»</button>
          <button onClick={() => setView("settings")} className="font-bold">è¨­å®š</button>
        </div>
      </header>

      <main className="flex-1 p-4 space-y-4">
        {view === "inventory" ? (
          <>
            <div className="flex gap-2">
              <button onClick={() => setDayMode("weekday")} className="flex-1 bg-blue-100 p-2 rounded">å¹³æ—¥</button>
              <button onClick={() => setDayMode("weekend")} className="flex-1 bg-orange-100 p-2 rounded">å‡æ—¥</button>
            </div>

            <div className="bg-white rounded-xl border">
              <table className="w-full text-sm">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="p-2 text-left">å“é …</th>
                    <th className="p-2 text-center">æ‡‰å‚™</th>
                    <th className="p-2 text-center">ç¾æœ‰</th>
                    <th className="p-2 text-right">è£œè²¨</th>
                  </tr>
                </thead>
                <tbody>
                  {items.map(item => {
                    const orderQty = calculateOrder(item);
                    const target = dayMode === "weekday" ? item.weekdayTarget : item.weekendTarget;
                    return (
                      <tr key={item.id} className="border-t">
                        <td className="p-2 font-bold">{item.name}</td>
                        <td className="p-2 text-center">{target}</td>
                        <td className="p-2">
                          <input
                            type="number"
                            className="w-full text-center border rounded"
                            value={item.currentStock}
                            onChange={e => updateItem(item.id, "currentStock", Number(e.target.value))}
                          />
                        </td>
                        <td className="p-2 text-right font-black text-red-600">
                          {orderQty > 0 ? `+${orderQty}` : "âœ”"}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            <div className="bg-slate-800 text-white p-4 rounded-xl">
              <div className="flex justify-between mb-2">
                <span className="font-bold">å«è²¨æ¸…å–®</span>
                <button onClick={copyToClipboard} className="text-sm bg-blue-600 px-3 py-1 rounded">
                  è¤‡è£½
                </button>
              </div>
              <pre className="whitespace-pre-wrap text-sm">{summaryText}</pre>
            </div>
          </>
        ) : (
          <>
            <button onClick={addItem} className="bg-slate-800 text-white px-4 py-2 rounded">
              æ–°å¢å“é …
            </button>
            {items.map(item => (
              <div key={item.id} className="bg-white p-4 rounded-xl border space-y-2">
                <div className="flex gap-2">
                  <input
                    className="flex-1 font-bold border-b"
                    value={item.name}
                    onChange={e => updateItem(item.id, "name", e.target.value)}
                  />
                  <input
                    className="w-16 text-center border rounded"
                    value={item.unit}
                    onChange={e => updateItem(item.id, "unit", e.target.value)}
                  />
                  <button onClick={() => deleteItem(item.id)}>ğŸ—‘</button>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <input type="number" className="compact-input"
                    value={item.weekdayTarget}
                    onChange={e => updateItem(item.id, "weekdayTarget", Number(e.target.value))}
                  />
                  <input type="number" className="compact-input"
                    value={item.weekendTarget}
                    onChange={e => updateItem(item.id, "weekendTarget", Number(e.target.value))}
                  />
                </div>
              </div>
            ))}
          </>
        )}
      </main>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
