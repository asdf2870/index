<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端盤點系統 - Firebase 實測版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK (瀏覽器模組版) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";

        // 您的 Firebase 配置資訊
        const firebaseConfig = {
            apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
            authDomain: "order-718b1.firebaseapp.com",
            projectId: "order-718b1",
            storageBucket: "order-718b1.firebasestorage.app",
            messagingSenderId: "454465000018",
            appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
            measurementId: "G-3MC1RTW85K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const appId = "order-inventory-system"; // 您專案的識別碼

        // 暴露給全域供 React 使用
        window.fb = { auth, db, appId, signInAnonymously, onAuthStateChanged, doc, setDoc, onSnapshot, collection, updateDoc, deleteDoc, addDoc };
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{width: size, height: size}}></i>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [view, setView] = useState('inventory');
            const [dayMode, setDayMode] = useState('weekday');
            const [loading, setLoading] = useState(true);

            // 1. 初始化登入
            useEffect(() => {
                const init = async () => {
                    const { auth, signInAnonymously, onAuthStateChanged } = window.fb;
                    try {
                        await signInAnonymously(auth);
                        onAuthStateChanged(auth, setUser);
                    } catch (err) {
                        console.error("Auth Error:", err);
                    }
                };
                init();
            }, []);

            // 2. 即時同步資料
            useEffect(() => {
                if (!user) return;
                const { db, appId, collection, onSnapshot } = window.fb;
                const path = collection(db, 'artifacts', appId, 'public', 'data', 'items');
                
                const unsubscribe = onSnapshot(path, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setItems(data);
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const updateItem = async (id, field, value) => {
                if (!user) return;
                const { db, appId, doc, updateDoc } = window.fb;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', id), { [field]: value });
            };

            const addItem = async () => {
                const { db, appId, collection, addDoc } = window.fb;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'items'), {
                    name: '新需求品項',
                    unit: '件',
                    weekdayTarget: 0,
                    weekendTarget: 0,
                    currentStock: 0,
                    roundUp: false,
                    createdAt: Date.now()
                });
            };

            const deleteItem = async (id) => {
                const { db, appId, doc, deleteDoc } = window.fb;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', id));
            };

            const calculateOrder = (item) => {
                const target = dayMode === 'weekday' ? (item.weekdayTarget || 0) : (item.weekendTarget || 0);
                let needed = target - (item.currentStock || 0);
                if (needed < 0) needed = 0;
                return item.roundUp ? Math.ceil(needed) : needed;
            };

            const summaryText = useMemo(() => {
                const filtered = items.map(i => ({...i, qty: calculateOrder(i)})).filter(i => i.qty > 0);
                if (!filtered.length) return "無須叫貨";
                return `【叫貨清單 - ${dayMode==='weekday'?'平日':'假日'}】\n` + filtered.map(i => `• ${i.name}: ${i.qty} ${i.unit}`).join('\n');
            }, [items, dayMode]);

            if (loading) return <div className="flex h-screen items-center justify-center text-slate-400 animate-pulse">連線雲端資料庫中...</div>;

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col pb-24">
                    <header className="bg-white/80 backdrop-blur border-b sticky top-0 z-20 px-4 py-4 flex justify-between items-center">
                        <h1 className="font-black text-xl text-indigo-600 flex items-center gap-2">
                            <Icon name="database" size={24}/> 雲端盤點
                        </h1>
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={()=>setView('inventory')} className={`px-4 py-1.5 rounded-lg text-xs font-bold ${view==='inventory'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>盤點</button>
                            <button onClick={()=>setView('settings')} className={`px-4 py-1.5 rounded-lg text-xs font-bold ${view==='settings'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>設定</button>
                        </div>
                    </header>

                    <main className="p-4 space-y-4">
                        {view === 'inventory' ? (
                            <>
                                <div className="flex gap-2">
                                    <button onClick={()=>setDayMode('weekday')} className={`flex-1 py-3 rounded-2xl font-bold border-2 transition ${dayMode==='weekday'?'bg-indigo-50 border-indigo-500 text-indigo-600':'bg-white border-slate-100 text-slate-300'}`}>平日盤點</button>
                                    <button onClick={()=>setDayMode('weekend')} className={`flex-1 py-3 rounded-2xl font-bold border-2 transition ${dayMode==='weekend'?'bg-amber-50 border-amber-500 text-amber-600':'bg-white border-slate-100 text-slate-300'}`}>假日盤點</button>
                                </div>
                                <div className="bg-white rounded-3xl border shadow-sm divide-y">
                                    {items.sort((a,b)=>a.createdAt-b.createdAt).map(item => {
                                        const qty = calculateOrder(item);
                                        return (
                                            <div key={item.id} className="flex items-center p-4 gap-4">
                                                <div className="flex-1">
                                                    <div className="font-black text-slate-700">{item.name}</div>
                                                    <div className="text-[10px] text-slate-400 uppercase tracking-wider font-bold">目標: {dayMode==='weekday'?item.weekdayTarget:item.weekendTarget} {item.unit}</div>
                                                </div>
                                                <input 
                                                    type="number"
                                                    className="w-20 text-center font-black text-xl bg-slate-100 rounded-xl py-2 focus:ring-2 ring-indigo-500 outline-none"
                                                    value={item.currentStock}
                                                    onChange={(e)=>updateItem(item.id, 'currentStock', parseFloat(e.target.value)||0)}
                                                />
                                                <div className="w-12 text-right font-black">
                                                    {qty > 0 ? <span className="text-red-500">+{qty}</span> : <Icon name="check" className="text-emerald-500 ml-auto"/>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="bg-slate-900 rounded-3xl p-5 text-white">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-xs font-bold text-slate-400">叫貨預覽 (即時同步)</span>
                                        <button onClick={()=>{navigator.clipboard.writeText(summaryText)}} className="text-[10px] bg-white/10 px-2 py-1 rounded">複製文字</button>
                                    </div>
                                    <pre className="text-sm font-sans opacity-90">{summaryText}</pre>
                                </div>
                            </>
                        ) : (
                            <div className="space-y-3">
                                <button onClick={addItem} className="w-full py-4 rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 font-bold hover:bg-slate-50 flex items-center justify-center gap-2">
                                    <Icon name="plus-circle"/> 新增品項
                                </button>
                                {items.map(item => (
                                    <div key={item.id} className="bg-white p-4 rounded-2xl border shadow-sm space-y-3">
                                        <div className="flex gap-2">
                                            <input className="flex-1 font-bold outline-none border-b border-transparent focus:border-indigo-500" value={item.name} onChange={(e)=>updateItem(item.id, 'name', e.target.value)}/>
                                            <input className="w-12 text-center text-sm text-slate-400 bg-slate-50 rounded" value={item.unit} onChange={(e)=>updateItem(item.id, 'unit', e.target.value)}/>
                                            <button onClick={()=>deleteItem(item.id)} className="text-slate-300 hover:text-red-500"><Icon name="x" size={18}/></button>
                                        </div>
                                        <div className="flex gap-4">
                                            <div className="flex-1 bg-slate-50 p-2 rounded-xl text-center">
                                                <label className="text-[10px] text-slate-400 block font-bold">平日應備</label>
                                                <input type="number" className="bg-transparent font-black w-full text-center" value={item.weekdayTarget} onChange={(e)=>updateItem(item.id, 'weekdayTarget', parseFloat(e.target.value)||0)}/>
                                            </div>
                                            <div className="flex-1 bg-slate-50 p-2 rounded-xl text-center">
                                                <label className="text-[10px] text-slate-400 block font-bold">假日應備</label>
                                                <input type="number" className="bg-transparent font-black w-full text-center" value={item.weekendTarget} onChange={(e)=>updateItem(item.id, 'weekendTarget', parseFloat(e.target.value)||0)}/>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    <footer className="fixed bottom-6 left-4 right-4 z-30">
                        <div className="bg-indigo-600 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-2 h-2 bg-emerald-400 rounded-full animate-ping"></div>
                                <div>
                                    <p className="text-[10px] opacity-70 leading-none">雲端連線中</p>
                                    <p className="text-xs font-bold">Order-718b1 專案</p>
                                </div>
                            </div>
                            <div className="text-[9px] font-mono opacity-50 bg-black/20 px-2 py-1 rounded">UID: {user?.uid.slice(0,8)}</div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
