import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Clipboard, 
  Settings, 
  LayoutDashboard, 
  Loader2,
  AlertCircle,
  CheckCircle2,
  Save
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  onSnapshot, 
  doc, 
  updateDoc, 
  deleteDoc, 
  query, 
  addDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- 初始化 Firebase ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'simple-stock-app';

// 自定義輸入組件，防止注音輸入法被中斷
const SafeInput = ({ value, onSave, className, placeholder, type = "text" }) => {
  const [localValue, setLocalValue] = useState(value);
  const isComposing = useRef(false);

  useEffect(() => {
    setLocalValue(value);
  }, [value]);

  const handleBlur = () => {
    if (localValue !== value) {
      onSave(type === "number" ? parseFloat(localValue) || 0 : localValue);
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !isComposing.current) {
      e.target.blur();
    }
  };

  return (
    <input
      type={type}
      value={localValue}
      placeholder={placeholder}
      className={className}
      onCompositionStart={() => { isComposing.current = true; }}
      onCompositionEnd={(e) => { 
        isComposing.current = false;
        setLocalValue(e.target.value);
      }}
      onChange={(e) => setLocalValue(e.target.value)}
      onBlur={handleBlur}
      onKeyDown={handleKeyDown}
    />
  );
};

const App = () => {
  const [items, setItems] = useState([]);
  const [user, setUser] = useState(null);
  const [dayMode, setDayMode] = useState('weekday'); 
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [authError, setAuthError] = useState(null);
  const [copySuccess, setCopySuccess] = useState(false);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        setAuthError("連線失敗：請確保 Firebase 已啟用匿名登入。");
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setItems(data.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0)));
    }, (err) => console.error(err));
    return () => unsubscribe();
  }, [user]);

  const updateItem = async (id, field, value) => {
    try {
      const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id);
      await updateDoc(itemRef, { [field]: value });
    } catch (err) {
      console.error(err);
    }
  };

  const addItem = async () => {
    const newItem = {
      name: '新項目',
      unit: '份',
      weekdayTarget: 10,
      weekendTarget: 15,
      currentStock: 0,
      roundUp: true,
      createdAt: Date.now()
    };
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), newItem);
  };

  const deleteItem = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id));
  };

  const calculateOrder = (item) => {
    const target = dayMode === 'weekday' ? (item.weekdayTarget || 0) : (item.weekendTarget || 0);
    const diff = target - (item.currentStock || 0);
    if (diff <= 0) return 0;
    return item.roundUp ? Math.ceil(diff) : diff;
  };

  const summaryText = useMemo(() => {
    return items
      .map(i => ({ name: i.name, qty: calculateOrder(i), unit: i.unit }))
      .filter(i => i.qty > 0)
      .map(i => `${i.name}: ${i.qty} ${i.unit}`)
      .join('\n');
  }, [items, dayMode]);

  const copyToClipboard = () => {
    const el = document.createElement('textarea');
    el.value = summaryText;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    setCopySuccess(true);
    setTimeout(() => setCopySuccess(false), 2000);
  };

  if (authError) return (
    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
      <AlertCircle className="w-12 h-12 text-red-500 mb-2" />
      <p>{authError}</p>
    </div>
  );

  if (!user) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin" /></div>;

  return (
    <div className="min-h-screen bg-slate-50 pb-24 text-slate-900">
      <header className="bg-white border-b sticky top-0 z-20">
        <div className="max-w-xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white"><LayoutDashboard size={18} /></div>
            <h1 className="font-bold">盤點助手</h1>
          </div>
          <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`p-2 rounded-xl ${isSettingsOpen ? 'bg-indigo-100 text-indigo-600' : 'text-slate-400'}`}><Settings size={22} /></button>
        </div>
      </header>

      <main className="max-w-xl mx-auto p-4 space-y-4">
        <div className="flex p-1 bg-slate-200 rounded-xl">
          {['weekday', 'weekend'].map(m => (
            <button key={m} onClick={() => setDayMode(m)} className={`flex-1 py-2 text-sm font-bold rounded-lg ${dayMode === m ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>
              {m === 'weekday' ? '平日' : '假日'}模式
            </button>
          ))}
        </div>

        {!isSettingsOpen ? (
          <div className="space-y-2">
            {items.map(item => (
              <div key={item.id} className="bg-white p-4 rounded-2xl border flex items-center justify-between">
                <div>
                  <div className="font-bold">{item.name}</div>
                  <div className="text-xs text-slate-400">目標: {dayMode === 'weekday' ? item.weekdayTarget : item.weekendTarget} {item.unit}</div>
                </div>
                <div className="flex items-center gap-4">
                  <SafeInput 
                    type="number"
                    value={item.currentStock}
                    onSave={(val) => updateItem(item.id, 'currentStock', val)}
                    className="w-20 text-center py-2 bg-slate-50 rounded-xl font-bold text-indigo-600 border-none focus:ring-2 focus:ring-indigo-500"
                  />
                  <div className="w-8 text-right font-bold text-orange-500">{calculateOrder(item) > 0 ? `+${calculateOrder(item)}` : ''}</div>
                </div>
              </div>
            ))}
            {summaryText && (
              <div className="mt-8 bg-slate-900 rounded-2xl p-4 text-white">
                <div className="flex justify-between mb-2">
                  <span className="text-xs font-bold text-slate-400">今日叫貨預估</span>
                  <button onClick={copyToClipboard} className="text-xs bg-white/10 px-2 py-1 rounded">{copySuccess ? '已複製' : '複製'}</button>
                </div>
                <pre className="text-sm font-sans">{summaryText}</pre>
              </div>
            )}
          </div>
        ) : (
          <div className="space-y-4">
            <button onClick={addItem} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:bg-slate-100 flex items-center justify-center gap-2"><Plus size={18}/> 新增項目</button>
            {items.map(item => (
              <div key={item.id} className="bg-white p-4 rounded-2xl border space-y-3">
                <div className="flex gap-2">
                  <SafeInput 
                    value={item.name}
                    onSave={(val) => updateItem(item.id, 'name', val)}
                    placeholder="項目名稱"
                    className="flex-1 bg-slate-50 p-2 rounded-lg font-bold border-none"
                  />
                  <SafeInput 
                    value={item.unit}
                    onSave={(val) => updateItem(item.id, 'unit', val)}
                    placeholder="單位"
                    className="w-16 bg-slate-50 p-2 rounded-lg text-center border-none"
                  />
                  <button onClick={() => deleteItem(item.id)} className="p-2 text-slate-300 hover:text-red-500"><Trash2 size={18}/></button>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="text-[10px] text-slate-400 font-bold ml-1">平日目標</label>
                    <SafeInput type="number" value={item.weekdayTarget} onSave={(val) => updateItem(item.id, 'weekdayTarget', val)} className="w-full bg-slate-50 p-2 rounded-lg border-none" />
                  </div>
                  <div>
                    <label className="text-[10px] text-slate-400 font-bold ml-1">假日目標</label>
                    <SafeInput type="number" value={item.weekendTarget} onSave={(val) => updateItem(item.id, 'weekendTarget', val)} className="w-full bg-slate-50 p-2 rounded-lg border-none" />
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>
      <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur px-4 py-2 rounded-full border shadow-lg text-[10px] text-slate-400 font-bold flex items-center gap-2">
        <div className="w-1.5 h-1.5 bg-green-500 rounded-full" /> 資料已實時同步
      </div>
    </div>
  );
};

export default App;
