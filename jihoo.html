<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ç›¤é»è£œè²¨ç³»çµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-3">
<div class="max-w-xl mx-auto space-y-3">

<header class="flex justify-between items-center">
  <h1 class="text-xl font-bold">ğŸ“¦ ç›¤é»è£œè²¨</h1>
  <button id="toggleManage" class="text-sm bg-gray-700 text-white px-2 py-1 rounded">
    ğŸ”§ ç®¡ç†å“é …
  </button>
</header>

<!-- å•†å®¶ -->
<select id="merchantSelect" class="w-full border p-2 rounded"></select>

<!-- å¹³å‡æ—¥ -->
<div class="flex gap-4 text-sm">
  <label><input type="radio" name="day" value="weekday" checked> å¹³æ—¥</label>
  <label><input type="radio" name="day" value="weekend"> å‡æ—¥</label>
</div>

<!-- å“é … -->
<div id="items" class="space-y-2"></div>

<!-- è£œè²¨æ¸…å–® -->
<div class="bg-yellow-50 p-3 rounded">
  <div class="flex justify-between items-center mb-1">
    <b>ğŸ§¾ è£œè²¨æ¸…å–®</b>
    <button id="copyOrder" class="text-xs bg-gray-700 text-white px-2 rounded">è¤‡è£½</button>
  </div>
  <pre id="orderList" class="text-sm"></pre>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain:"ngdd-8dd14.firebaseapp.com",
  databaseURL:"https://ngdd-8dd14-default-rtdb.firebaseio.com",
  projectId:"ngdd-8dd14"
});
const db = getDatabase(app);

let merchant=null, items={}, stocks={}, day="weekday", manage=false;

toggleManage.onclick=()=>{
  manage=!manage;
  toggleManage.textContent=manage?"âœ… å®Œæˆ":"ğŸ”§ ç®¡ç†å“é …";
  render();
};

document.getElementsByName("day").forEach(r=>{
  r.onchange=e=>{day=e.target.value;render();}
});

onValue(ref(db,"merchants"),s=>{
  merchantSelect.innerHTML="";
  s.forEach(c=>{
    let o=document.createElement("option");
    o.value=c.key;o.textContent=c.val().name;
    merchantSelect.appendChild(o);
  });
  if(!merchant){merchant=merchantSelect.value;load();}
});
merchantSelect.onchange=()=>{merchant=merchantSelect.value;load();};

function load(){
  onValue(ref(db,`data/${merchant}/items`),s=>{items=s.val()||{};render();});
  onValue(ref(db,`data/${merchant}/stocks`),s=>{stocks=s.val()||{};render();});
}

function render(){
  itemsBox.innerHTML="";
  let order={};

  Object.entries(items).forEach(([id,it])=>{
    const min=day==="weekday"?it.weekdayMin:it.weekendMin;
    const cur=stocks[id]||0;
    const need=Math.max(0,min-cur);

    const d=document.createElement("div");
    d.className="bg-white p-2 rounded shadow text-sm space-y-1";

    if(!manage){
      d.innerHTML=`
        <div class="font-bold">${it.name}ï¼ˆæœ€ä½ ${min}${it.unit}ï¼‰</div>
        <div class="flex gap-2 items-center">
          <input type="number" class="border p-1 flex-1" value="${cur}">
          <span class="${need>0?'text-red-500':'text-green-600'}">
            ${need>0?`ç¼º ${need}`:"OK"}
          </span>
        </div>
      `;
      d.querySelector("input").oninput=e=>{
        set(ref(db,`data/${merchant}/stocks/${id}`),+e.target.value);
      };
    }else{
      d.innerHTML=`
        <input class="border p-1 w-full" value="${it.name}">
        <input class="border p-1 w-full" value="${it.unit}">
        <input type="number" class="border p-1 w-full" value="${it.weekdayMin}">
        <input type="number" class="border p-1 w-full" value="${it.weekendMin}">
        <button class="text-red-500 text-xs">åˆªé™¤å“é …</button>
      `;
      const [n,u,w,h,del]=d.querySelectorAll("input,button");
      n.oninput=e=>update(ref(db,`data/${merchant}/items/${id}`),{name:e.target.value});
      u.oninput=e=>update(ref(db,`data/${merchant}/items/${id}`),{unit:e.target.value});
      w.oninput=e=>update(ref(db,`data/${merchant}/items/${id}`),{weekdayMin:+e.target.value});
      h.oninput=e=>update(ref(db,`data/${merchant}/items/${id}`),{weekendMin:+e.target.value});
      del.onclick=()=>confirm("åˆªé™¤ï¼Ÿ")&&remove(ref(db,`data/${merchant}/items/${id}`));
    }

    itemsBox.appendChild(d);

    if(need>0){
      (it.links||[]).forEach(l=>{
        const k=l.name+l.unit;
        order[k]=(order[k]||0)+l.qty*need;
      });
    }
  });

  orderList.textContent=Object.entries(order)
    .map(([k,v])=>`${k} +${v}`).join("\n")||"ç›®å‰ç„¡éœ€è£œè²¨";
}

copyOrder.onclick=()=>navigator.clipboard.writeText(orderList.textContent);

const itemsBox=document.getElementById("items");
</script>
</body>
</html>
