<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多商家盤點補貨系統</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v9 CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, push, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /********************
     * Firebase 設定
     ********************/
    const firebaseConfig = {
      apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
      authDomain: "ngdd-8dd14.firebaseapp.com",
      databaseURL: "https://ngdd-8dd14-default-rtdb.firebaseio.com",
      projectId: "ngdd-8dd14",
      storageBucket: "ngdd-8dd14.firebasestorage.app",
      messagingSenderId: "780195335307",
      appId: "1:780195335307:web:c6e95d1e0a7ee92cf3588e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /********************
     * 狀態
     ********************/
    let currentMerchant = null;
    let merchants = {};
    let items = {};
    let isHoliday = false;

    /********************
     * DOM
     ********************/
    const merchantSelect = document.getElementById('merchantSelect');
    const merchantList = document.getElementById('merchantList');
    const itemList = document.getElementById('itemList');
    const restockList = document.getElementById('restockList');

    /********************
     * 初始化 merchants
     ********************/
    const merchantsRef = ref(db, 'inventory_tool/merchants');
    onValue(merchantsRef, snap => {
      if (!snap.exists()) {
        set(merchantsRef, { '商家A': true });
        return;
      }
      merchants = snap.val();
      renderMerchantSelect();
    });

    function renderMerchantSelect() {
      merchantSelect.innerHTML = '';
      Object.keys(merchants).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        merchantSelect.appendChild(opt);
      });
      if (!currentMerchant) {
        currentMerchant = Object.keys(merchants)[0];
        merchantSelect.value = currentMerchant;
        loadMerchantData();
      }
    }

    window.changeMerchant = () => {
      currentMerchant = merchantSelect.value;
      loadMerchantData();
    };

    /********************
     * 商家管理
     ********************/
    window.addMerchant = () => {
      const name = prompt('輸入新商家名稱');
      if (!name) return;
      set(ref(db, `inventory_tool/merchants/${name}`), true);
      set(ref(db, `inventory_tool/data/${name}`), { items: {} });
    };

    window.deleteMerchant = () => {
      if (!currentMerchant) return;
      if (!confirm(`確定刪除商家 ${currentMerchant}？`)) return;
      remove(ref(db, `inventory_tool/merchants/${currentMerchant}`));
      remove(ref(db, `inventory_tool/data/${currentMerchant}`));
      currentMerchant = null;
    };

    /********************
     * 載入商家資料
     ********************/
    function loadMerchantData() {
      const dataRef = ref(db, `inventory_tool/data/${currentMerchant}/items`);
      onValue(dataRef, snap => {
        items = snap.val() || {};
        renderItems();
        renderRestock();
      });
    }

    /********************
     * 品項
     ********************/
    window.addItem = () => {
      const name = document.getElementById('newItemName').value;
      const min = Number(document.getElementById('newItemMin').value);
      const related = document.getElementById('newItemRelated').value;
      if (!name) return;
      push(ref(db, `inventory_tool/data/${currentMerchant}/items`), {
        name,
        minNormal: min,
        minHoliday: min,
        stock: 0,
        related: related.split(',').map(s => s.trim()).filter(Boolean)
      });
      document.getElementById('newItemName').value = '';
      document.getElementById('newItemMin').value = '';
      document.getElementById('newItemRelated').value = '';
    };

    function renderItems() {
      itemList.innerHTML = '';
      Object.entries(items).forEach(([id, item]) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-3 gap-2 items-center';
        row.innerHTML = `
          <div>${item.name}</div>
          <input type="number" value="${item.stock || 0}" class="border p-1" />
          <button class="text-red-500">刪除</button>
        `;
        const input = row.querySelector('input');
        input.onchange = e => update(ref(db, `inventory_tool/data/${currentMerchant}/items/${id}`), { stock: Number(e.target.value) });
        row.querySelector('button').onclick = () => remove(ref(db, `inventory_tool/data/${currentMerchant}/items/${id}`));
        itemList.appendChild(row);
      });
    }

    /********************
     * 補貨清單
     ********************/
    function renderRestock() {
      restockList.innerHTML = '';
      Object.values(items).forEach(item => {
        const min = isHoliday ? item.minHoliday : item.minNormal;
        const need = min - (item.stock || 0);
        if (need > 0) {
          const li = document.createElement('li');
          li.textContent = item.related.length ? item.related.join('、') : `${item.name} ${need}`;
          restockList.appendChild(li);
        }
      });
    }

    window.toggleHoliday = () => {
      isHoliday = !isHoliday;
      renderRestock();
    };

    window.copyRestock = () => {
      const text = Array.from(restockList.children).map(li => li.textContent).join('\n');
      navigator.clipboard.writeText(text);
      alert('已複製補貨清單');
    };
  </script>
</head>
<body class="p-4 space-y-4">
  <h1 class="text-xl font-bold">多商家盤點補貨系統</h1>

  <div class="flex gap-2">
    <select id="merchantSelect" onchange="changeMerchant()" class="border p-2"></select>
    <button onclick="addMerchant()" class="border px-2">＋商家</button>
    <button onclick="deleteMerchant()" class="border px-2 text-red-500">刪除商家</button>
  </div>

  <div class="border p-3">
    <h2 class="font-bold">品項盤點</h2>
    <div id="itemList" class="space-y-2"></div>
  </div>

  <div class="border p-3">
    <h2 class="font-bold">新增品項</h2>
    <input id="newItemName" placeholder="品項名稱" class="border p-1 w-full mb-1" />
    <input id="newItemMin" placeholder="最低庫存" type="number" class="border p-1 w-full mb-1" />
    <input id="newItemRelated" placeholder="關聯食材（逗號分隔）" class="border p-1 w-full mb-1" />
    <button onclick="addItem()" class="border px-2">新增品項</button>
  </div>

  <div class="border p-3">
    <h2 class="font-bold">補貨清單</h2>
    <button onclick="toggleHoliday()" class="border px-2">切換平/假日</button>
    <button onclick="copyRestock()" class="border px-2">複製</button>
    <ul id="restockList" class="list-disc pl-5"></ul>
  </div>
</body>
</html>
