<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>多商家盤點叫貨系統</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { font-family: 'Noto Sans TC', sans-serif; background:#f8fafc; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo } = React;

// Firebase 初始化
const firebaseConfig = {
  apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain: "ngdd-8dd14.firebaseapp.com",
  projectId: "ngdd-8dd14",
  storageBucket: "ngdd-8dd14.firebasestorage.app",
  messagingSenderId: "780195335307",
  appId: "1:780195335307:web:c6e95d1e0a7ee92cf3588e",
  databaseURL: "https://ngdd-8dd14-default-rtdb.firebaseio.com" // ✅ 必須加
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Icon 簡單函數
const Icon = ({ name, size=18, className="" }) => {
  useEffect(() => {
    if(window.lucide) window.lucide.createIcons({attrs:{class:className,width:size,height:size,'stroke-width':2.5}, nameAttr:'data-lucide'});
  }, [name,size,className]);
  return <i data-lucide={name} className={className}></i>;
};

const App = () => {
  const [merchants, setMerchants] = useState([]);
  const [currentMerchant, setCurrentMerchant] = useState('');
  const [items, setItems] = useState([]);
  const [stockCounts, setStockCounts] = useState({});
  const [dayType, setDayType] = useState('weekday');
  const [loading, setLoading] = useState(true);

  // 監聽商家列表
  useEffect(() => {
    const ref = db.ref('merchants');
    ref.on('value', snapshot=>{
      const val = snapshot.val() || [];
      setMerchants(val);
      if(!currentMerchant && val.length>0) setCurrentMerchant(val[0]);
    });
    return ()=>ref.off();
  }, []);

  // 監聽商家品項
  useEffect(()=>{
    if(!currentMerchant) return;
    setLoading(true);
    const ref = db.ref(`inventory_tool/${currentMerchant}`);
    ref.on('value', snapshot=>{
      const val = snapshot.val() || {};
      setItems(val.items || []);
      setStockCounts(val.stockCounts || {});
      setLoading(false);
    });
    return ()=>ref.off();
  }, [currentMerchant]);

  // 雲端同步
  const syncToCloud = (newItems, newCounts)=>{
    if(!currentMerchant) return;
    db.ref(`inventory_tool/${currentMerchant}`).update({items:newItems,stockCounts:newCounts});
  };

  // 新增/更新/刪除品項
  const addItem = ()=>{
    const newItem = {id:Date.now(), name:'', weekdayMin:0, weekendMin:0, unit:'', shouldRound:false};
    const updatedItems = [...items,newItem];
    setItems(updatedItems);
    syncToCloud(updatedItems, stockCounts);
  };
  const updateItem = (id, field, value)=>{
    const updatedItems = items.map(it=>it.id===id?{...it,[field]:value}:it);
    setItems(updatedItems);
    syncToCloud(updatedItems, stockCounts);
  };
  const deleteItem = (id)=>{
    if(confirm('確定刪除此品項？')){
      const updatedItems = items.filter(it=>it.id!==id);
      const newCounts = {...stockCounts};
      delete newCounts[id];
      setItems(updatedItems);
      setStockCounts(newCounts);
      syncToCloud(updatedItems,newCounts);
    }
  };

  const calculateNeed = (item)=>{
    const current = parseFloat(stockCounts[item.id]||0);
    const min = dayType==='weekday'?item.weekdayMin:item.weekendMin;
    let need = min - current;
    if(need<=0 || isNaN(need)) return 0;
    return item.shouldRound?Math.round(need):parseFloat(need.toFixed(2));
  };

  const orderList = useMemo(()=>{
    return items.map(item=>{
      const need = calculateNeed(item);
      return need>0?{name:item.name, need, unit:item.unit}:null;
    }).filter(Boolean);
  }, [items, stockCounts, dayType]);

  const copyOrder = ()=>{
    const label = dayType==='weekday'?'平日':'假日';
    const summary = orderList.map(i=>`${i.name}: ${i.need} ${i.unit}`).join('\n');
    const text = summary?`【${currentMerchant} ${label}補貨清單】\n${summary}`:"無需補貨";
    const textArea = document.createElement('textarea');
    textArea.value=text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('已複製清單');
  };

  const addMerchant = ()=>{
    const name = prompt('輸入新商家名稱');
    if(!name) return;
    const updated = [...merchants,name];
    db.ref('merchants').set(updated);
  };
  const deleteMerchant = (name)=>{
    if(!confirm(`確定刪除商家 ${name}？`)) return;
    const updated = merchants.filter(m=>m!==name);
    db.ref('merchants').set(updated);
  };

  if(loading) return <div className="flex h-screen items-center justify-center font-bold text-slate-400 animate-pulse">盤點資料讀取中...</div>;

  return (
    <div className="min-h-screen flex flex-col max-w-3xl mx-auto bg-white shadow-lg">
      {/* Header */}
      <header className="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg">
        <div className="flex justify-between items-center mb-3">
          <h1 className="text-lg font-bold">多商家盤點工具</h1>
          <div className="flex gap-2">
            <button onClick={addMerchant} className="bg-blue-600 px-2 py-1 rounded text-xs font-bold">新增商家</button>
            {currentMerchant && <button onClick={()=>deleteMerchant(currentMerchant)} className="bg-red-500 px-2 py-1 rounded text-xs font-bold">刪除商家</button>}
          </div>
        </div>
        <div className="flex gap-2 mb-2 overflow-x-auto">
          {merchants.map(m=>(
            <button key={m} className={`px-3 py-1 rounded ${m===currentMerchant?'bg-blue-500 text-white':'bg-slate-200 text-slate-600'}`} onClick={()=>setCurrentMerchant(m)}>{m}</button>
          ))}
        </div>
        <div className="flex bg-slate-800 p-1 rounded-lg">
          <button onClick={()=>setDayType('weekday')} className={`flex-1 py-1.5 text-xs font-bold ${dayType==='weekday'?'bg-slate-700 text-blue-400':'text-slate-500'}`}>平日</button>
          <button onClick={()=>setDayType('weekend')} className={`flex-1 py-1.5 text-xs font-bold ${dayType==='weekend'?'bg-slate-700 text-orange-400':'text-slate-500'}`}>假日</button>
        </div>
      </header>

      {/* 主內容 */}
      <main className="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3">
        {items.map(item=>(
          <div key={item.id} className="p-3 bg-slate-50 rounded-lg flex flex-col gap-2">
            <div className="flex items-center gap-2">
              <input value={item.name} onChange={e=>updateItem(item.id,'name',e.target.value)} placeholder="品項名稱" className="flex-1 font-bold border-b border-slate-200 outline-none p-1"/>
              <input value={item.unit} onChange={e=>updateItem(item.id,'unit',e.target.value)} placeholder="單位" className="w-12 text-center p-1 bg-slate-100 rounded"/>
              <button onClick={()=>deleteItem(item.id)} className="text-red-500 font-bold">×</button>
            </div>
            <div className="flex gap-2">
              <input type="number" value={item.weekdayMin} onChange={e=>updateItem(item.id,'weekdayMin',parseFloat(e.target.value)||0)} className="flex-1 p-1 rounded bg-white text-sm" placeholder="平日數量"/>
              <input type="number" value={item.weekendMin} onChange={e=>updateItem(item.id,'weekendMin',parseFloat(e.target.value)||0)} className="flex-1 p-1 rounded bg-white text-sm" placeholder="假日數量"/>
              <button onClick={()=>updateItem(item.id,'shouldRound',!item.shouldRound)} className={`px-2 py-1 text-xs rounded ${item.shouldRound?'bg-green-200 text-green-700':'bg-slate-200 text-slate-500'}`}>四捨五入</button>
            </div>
            <div className="flex items-center gap-2">
              <input type="number" value={stockCounts[item.id]||''} onChange={e=>{
                const newCounts = {...stockCounts,[item.id]:e.target.value};
                setStockCounts(newCounts);
                syncToCloud(items,newCounts);
              }} className="p-1 w-24 text-center rounded bg-white border"/>
              <span className="text-sm text-slate-500">{item.unit}</span>
              <span className="font-bold text-red-500 ml-2">{calculateNeed(item)>0?`+${calculateNeed(item)}`:'OK'}</span>
            </div>
          </div>
        ))}
        <button onClick={addItem} className="w-full py-2 border-2 border-dashed rounded text-sm text-slate-400 font-bold">+ 新增品項</button>
      </main>

      {/* Footer 補貨清單 */}
      <footer className="bg-slate-50 border-t border-slate-200 p-3">
        {orderList.length>0?(
          <div className="text-sm text-slate-700 whitespace-pre-wrap mb-2">
            {orderList.map((i,idx)=>(
              <div key={idx}>{i.name}: {i.need} {i.unit}</div>
            ))}
          </div>
        ):<p className="text-xs text-slate-400">目前無需補貨</p>}
        <button onClick={copyOrder} className="w-full py-2 bg-blue-600 text-white font-bold rounded">複製補貨清單</button>
      </footer>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
