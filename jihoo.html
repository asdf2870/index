<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>盤點叫貨系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    // =====================
    // Firebase 初始化 (新設定)
    // =====================
    const firebaseConfig = {
        apiKey: "AIzaSyCu_W2qzTZTMm0cOh1Gc7ys8uDKJEkzD7M",
        authDomain: "all-sun-e7472.firebaseapp.com",
        projectId: "all-sun-e7472",
        storageBucket: "all-sun-e7472.firebasestorage.app",
        messagingSenderId: "679291601652",
        appId: "1:679291601652:web:af747f74bdb9afe0bc94a1",
        measurementId: "G-JP2QM56TC5",
        databaseURL: "https://all-sun-e7472-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =====================
    // React App
    // =====================
    const { useState, useEffect, useMemo } = React;

    const Icon = ({ name, size = 18, className = "" }) => {
        useEffect(() => {
            if (window.lucide) window.lucide.createIcons({ attrs: { class: className, 'stroke-width': 2.5, width: size, height: size }, nameAttr: 'data-lucide' });
        }, [name, size, className]);
        return <i data-lucide={name} className={className}></i>;
    };

    const App = () => {
        const [loading, setLoading] = useState(true);
        const [items, setItems] = useState([]);
        const [stockCounts, setStockCounts] = useState({});
        const [dayType, setDayType] = useState('weekday'); // 平日/假日
        const [showCopySuccess, setShowCopySuccess] = useState(false);

        // 讀取 Firebase 資料
        useEffect(() => {
            const ref = db.ref('inventory_tool');
            ref.on('value', snapshot => {
                const val = snapshot.val();
                if (val) {
                    setItems(val.items || []);
                    setStockCounts(val.stockCounts || {});
                }
                setLoading(false);
            });
            return () => ref.off();
        }, []);

        const syncToCloud = (newItems, newCounts) => {
            db.ref('inventory_tool').update({ items: newItems, stockCounts: newCounts });
        };

        const addItem = () => {
            const newItem = { id: Date.now(), name: '', weekdayMin: 0, weekendMin: 0, unit: '', shouldRound: false, related: [] };
            const newItems = [...items, newItem];
            setItems(newItems);
            syncToCloud(newItems, stockCounts);
        };

        const calculateNeed = (item, currentStock) => {
            const stock = parseFloat(currentStock || 0);
            const min = dayType === 'weekday' ? item.weekdayMin : item.weekendMin;
            let need = min - stock;
            if (need <= 0 || isNaN(need)) return 0;
            return item.shouldRound ? Math.round(need) : parseFloat(need.toFixed(1));
        };

        const orderList = useMemo(() => {
            return items.map(item => {
                const need = calculateNeed(item, stockCounts[item.id]);
                return need > 0 ? (item.related && item.related.length > 0 ? item.related : [{name: item.name, need, unit: item.unit}]) : null;
            }).filter(Boolean).flat();
        }, [items, stockCounts, dayType]);

        const copyOrder = () => {
            const label = dayType === 'weekday' ? '平日' : '假日';
            const summary = orderList.map(i => `${i.name} ${i.need ? i.need + i.unit : ''}`).join('\n');
            const text = summary ? `【${label}補貨清單】\n${summary}` : "無需補貨";

            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);

            setShowCopySuccess(true);
            setTimeout(() => setShowCopySuccess(false), 2000);
        };

        if (loading) return <div className="flex h-screen items-center justify-center text-slate-400 font-bold animate-pulse">盤點資料讀取中...</div>;

        return (
            <div className="min-h-screen flex flex-col max-w-2xl mx-auto bg-white shadow-2xl overflow-hidden">
                <header className="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg">
                    <div className="flex justify-between items-center mb-3">
                        <h1 className="text-lg font-bold flex items-center gap-2 tracking-tight">
                            <Icon name="calculator" className="text-blue-400" size={20} /> 盤點計算工具
                        </h1>
                    </div>
                    <div className="flex bg-slate-800 p-1 rounded-lg">
                        <button onClick={() => setDayType('weekday')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${dayType==='weekday'?'bg-slate-700 text-blue-400 shadow-sm':'text-slate-500'}`}>平日</button>
                        <button onClick={() => setDayType('weekend')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${dayType==='weekend'?'bg-slate-700 text-orange-400 shadow-sm':'text-slate-500'}`}>假日</button>
                    </div>
                </header>

                <main className="flex-1 overflow-y-auto custom-scrollbar p-3">
                    {items.map(item => (
                        <div key={item.id} className="py-2 flex items-center gap-3">
                            <div className="flex-1 min-w-0">
                                <span className="font-bold text-sm truncate">{item.name}</span>
                            </div>
                            <input type="number" step="0.5" value={stockCounts[item.id]||''} onChange={e=>{
                                const newCounts = {...stockCounts, [item.id]: e.target.value};
                                setStockCounts(newCounts);
                                syncToCloud(items,newCounts);
                            }} className="w-20 bg-slate-100 border-none rounded-lg py-1.5 px-2 text-right text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none"/>
                            <span className="text-[10px] text-slate-400 font-bold">{item.unit}</span>
                        </div>
                    ))}
                </main>

                <footer className="bg-slate-50 border-t border-slate-200 shadow-inner p-4">
                    <div className="max-h-40 overflow-y-auto custom-scrollbar mb-3 bg-white border border-slate-200 rounded-lg p-2">
                        {orderList.length>0 ? orderList.map((i,idx)=>(
                            <div key={idx} className="text-xs text-slate-700">{i.name} {i.need?`+${i.need}${i.unit}`:''}</div>
                        )):<p className="text-[10px] text-center text-slate-300 py-2">目前無缺貨品項</p>}
                    </div>
                    <button onClick={copyOrder} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg ${showCopySuccess?'bg-green-500':'bg-blue-600'}`}>
                        <Icon name={showCopySuccess?"check":"copy"} size={16} />
                        {showCopySuccess?"已複製":"一鍵複製補貨清單"}
                    </button>
                </footer>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
