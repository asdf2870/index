<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å¤šå•†å®¶ç›¤é»è£œè²¨ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-4">
<div class="max-w-4xl mx-auto space-y-4">

  <h1 class="text-2xl font-bold">ğŸ“¦ å¤šå•†å®¶ç›¤é»è£œè²¨ç³»çµ±</h1>

  <!-- å•†å®¶ -->
  <div class="flex gap-2">
    <select id="merchantSelect" class="border p-2 flex-1"></select>
    <button id="addMerchant" class="bg-blue-600 text-white px-3">ï¼‹å•†å®¶</button>
    <button id="delMerchant" class="bg-red-600 text-white px-3">åˆªé™¤</button>
  </div>

  <!-- å¹³å‡æ—¥ -->
  <div class="flex gap-4 items-center">
    <label><input type="radio" name="day" value="weekday" checked> å¹³æ—¥</label>
    <label><input type="radio" name="day" value="weekend"> å‡æ—¥</label>
  </div>

  <!-- ç›¤é» -->
  <div id="items" class="space-y-2"></div>

  <!-- è£œè²¨æ¸…å–® -->
  <div class="bg-yellow-50 p-3 rounded shadow space-y-2">
    <div class="flex justify-between items-center">
      <h2 class="font-bold">ğŸ§¾ è£œè²¨æ¸…å–®</h2>
      <button id="copyOrder" class="bg-gray-700 text-white px-2 py-1 text-sm">ğŸ“‹ è¤‡è£½</button>
    </div>
    <pre id="orderList" class="whitespace-pre-wrap"></pre>
  </div>

  <!-- æ–°å¢å“é … -->
  <div class="bg-white p-3 rounded shadow space-y-2">
    <h2 class="font-bold">â• æ–°å¢å“é …</h2>
    <input id="itemName" class="border p-1 w-full" placeholder="å“é …åç¨±">
    <input id="itemUnit" class="border p-1 w-full" placeholder="å–®ä½">
    <input id="itemWeekday" type="number" class="border p-1 w-full" placeholder="å¹³æ—¥æœ€ä½åº«å­˜">
    <input id="itemWeekend" type="number" class="border p-1 w-full" placeholder="å‡æ—¥æœ€ä½åº«å­˜">

    <textarea id="itemLinks" class="border p-1 w-full"
      placeholder="é—œè¯é£Ÿæï¼ˆä¸€è¡Œä¸€å€‹ï¼‰&#10;æ ¼å¼ï¼šé¦¬éˆ´è–¯,é¡†,2"></textarea>

    <button id="addItem" class="bg-green-600 text-white px-3 py-1">æ–°å¢å“é …</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain: "ngdd-8dd14.firebaseapp.com",
  projectId: "ngdd-8dd14",
  storageBucket: "ngdd-8dd14.firebasestorage.app",
  messagingSenderId: "780195335307",
  appId: "1:780195335307:web:c6e95d1e0a7ee92cf3588e",
  databaseURL: "https://ngdd-8dd14-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let merchant = null;
let items = {};
let stocks = {};
let dayType = "weekday";

const merchantSelect = document.getElementById("merchantSelect");

onValue(ref(db, "merchants"), s => {
  merchantSelect.innerHTML = "";
  s.forEach(c => {
    const o = document.createElement("option");
    o.value = c.key;
    o.textContent = c.val().name;
    merchantSelect.appendChild(o);
  });
  if (!merchant && merchantSelect.value) {
    merchant = merchantSelect.value;
    loadData();
  }
});

merchantSelect.onchange = () => {
  merchant = merchantSelect.value;
  loadData();
};

document.getElementsByName("day").forEach(r => {
  r.onchange = e => {
    dayType = e.target.value;
    render();
  };
});

function loadData() {
  onValue(ref(db, `data/${merchant}/items`), s => {
    items = s.val() || {};
    render();
  });
  onValue(ref(db, `data/${merchant}/stocks`), s => {
    stocks = s.val() || {};
    render();
  });
}

document.getElementById("addMerchant").onclick = () => {
  const n = prompt("å•†å®¶åç¨±");
  if (!n) return;
  set(ref(db, `merchants/m_${Date.now()}`), { name: n });
};

document.getElementById("delMerchant").onclick = () => {
  if (confirm("ç¢ºå®šåˆªé™¤å•†å®¶ï¼Ÿ")) {
    remove(ref(db, `merchants/${merchant}`));
    remove(ref(db, `data/${merchant}`));
  }
};

document.getElementById("addItem").onclick = () => {
  const links = itemLinks.value.split("\n").filter(Boolean).map(l => {
    const [name, unit, qty] = l.split(",");
    return { name, unit, qty: Number(qty) };
  });

  push(ref(db, `data/${merchant}/items`), {
    name: itemName.value,
    unit: itemUnit.value,
    weekdayMin: Number(itemWeekday.value),
    weekendMin: Number(itemWeekend.value),
    links
  });

  itemName.value = itemUnit.value = itemWeekday.value = itemWeekend.value = itemLinks.value = "";
};

function render() {
  const box = document.getElementById("items");
  let order = "";
  box.innerHTML = "";

  Object.entries(items).forEach(([id, item]) => {
    const min = dayType === "weekday" ? item.weekdayMin : item.weekendMin;
    const cur = stocks[id] || 0;
    const need = Math.max(0, min - cur);

    const d = document.createElement("div");
    d.className = "bg-white p-2 rounded shadow";
    d.innerHTML = `
      <div class="font-bold">${item.name}ï¼ˆæœ€ä½ ${min}${item.unit}ï¼‰</div>
      <input type="number" class="border p-1 w-full mt-1" value="${cur}">
    `;
    d.querySelector("input").oninput = e => {
      set(ref(db, `data/${merchant}/stocks/${id}`), Number(e.target.value));
    };
    box.appendChild(d);

    if (need > 0) {
      order += `${item.name} +${need}${item.unit}\n`;
      (item.links || []).forEach(l => {
        order += `  ãƒ»${l.name} +${l.qty * need}${l.unit}\n`;
      });
    }
  });

  document.getElementById("orderList").textContent = order || "ç›®å‰ç„¡éœ€è£œè²¨";
}

document.getElementById("copyOrder").onclick = () => {
  navigator.clipboard.writeText(orderList.textContent);
  alert("å·²è¤‡è£½è£œè²¨æ¸…å–®");
};
</script>
</body>
</html>
