<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盤點叫貨系統（多商家）</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f8fafc; }
</style>
</head>
<body>
<div id="root" class="max-w-xl mx-auto p-3"></div>

<script>
/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey: "AIzaSyCu_W2qzTZTMm0cOh1Gc7ys8uDKJEkzD7M",
  authDomain: "all-sun-e7472.firebaseapp.com",
  projectId: "all-sun-e7472",
  storageBucket: "all-sun-e7472.firebasestorage.app",
  messagingSenderId: "679291601652",
  appId: "1:679291601652:web:af747f74bdb9afe0bc94a1",
  databaseURL: "https://all-sun-e7472-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========= 狀態 ========= */
let merchants = [];
let currentMerchant = '';
let page = 'inventory'; // inventory | manage
let dayType = 'weekday';
let items = [];
let stockCounts = {};

const root = document.getElementById('root');

/* ========= Render ========= */
function render(){
  root.innerHTML = '';
  const wrap = document.createElement('div');

  /* 商家切換 */
  wrap.innerHTML += `
    <div class="flex gap-2 mb-3">
      <select id="merchantSel" class="flex-1 border rounded px-2 py-1">
        ${merchants.map(m=>`<option ${m===currentMerchant?'selected':''}>${m}</option>`).join('')}
      </select>
      <button id="merchantMgr" class="px-2 bg-slate-500 text-white rounded">商家</button>
    </div>
  `;

  /* Header + 清除盤點 */
  wrap.innerHTML += `
    <div class="flex justify-between items-center mb-3 gap-2">
      <h1 class="font-bold text-lg flex-1">盤點叫貨系統</h1>
      ${page==='inventory'
        ? `<button id="clearStock" class="px-2 py-1 bg-red-500 text-white rounded text-sm">清除盤點</button>`
        : ``}
      <button id="togglePage" class="px-3 py-1 bg-blue-600 text-white rounded">
        ${page==='inventory'?'管理品項':'返回盤點'}
      </button>
    </div>
  `;

  /* 平假日 */
  if(page==='inventory'){
    wrap.innerHTML += `
      <div class="flex gap-2 mb-3">
        <button id="wd" class="flex-1 py-1 rounded ${dayType==='weekday'?'bg-blue-600 text-white':'bg-slate-200'}">平日</button>
        <button id="we" class="flex-1 py-1 rounded ${dayType==='weekend'?'bg-orange-500 text-white':'bg-slate-200'}">假日</button>
      </div>
    `;
  }

  const list = document.createElement('div');
  list.className = 'space-y-2';

  /* ===== 盤點頁 ===== */
  if(page==='inventory'){
    items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2 bg-white p-2 rounded shadow';
      row.innerHTML = `
        <div class="flex-1">${it.name}</div>
        <button onclick="adj('${it.id}',-0.5)">-</button>
        <input type="number" step="0.5" class="w-16 text-center border rounded"
          value="${stockCounts[it.id]||0}">
        <span class="text-sm text-slate-500">${it.unit||''}</span>
        <button onclick="adj('${it.id}',0.5)">+</button>
      `;
      row.querySelector('input').oninput=e=>{
        stockCounts[it.id]=parseFloat(e.target.value)||0;
        sync();
        render();
      };
      list.appendChild(row);
    });
  }

  /* ===== 管理頁 ===== */
  if(page==='manage'){
    items.forEach(it=>{
      const row = document.createElement('div');
      row.className='bg-white p-2 rounded shadow space-y-1 text-sm';
      row.innerHTML = `
        <input class="w-full border-b" value="${it.name}" placeholder="品項名稱">
        <div class="flex gap-1">
          <input type="number" step="0.5" class="w-1/4 border rounded px-1" value="${it.weekdayMin||0}" placeholder="平日">
          <input type="number" step="0.5" class="w-1/4 border rounded px-1" value="${it.weekendMin||0}" placeholder="假日">
          <input class="w-1/4 border rounded px-1" value="${it.unit||''}" placeholder="單位">
        </div>
        <input class="w-full border rounded px-1 text-xs"
          value="${(it.relatedItems||[]).join(',')}"
          placeholder="關聯食材（逗號）">
      `;
      const ins=row.querySelectorAll('input');
      ins[0].oninput=e=>it.name=e.target.value;
      ins[1].oninput=e=>it.weekdayMin=parseFloat(e.target.value)||0;
      ins[2].oninput=e=>it.weekendMin=parseFloat(e.target.value)||0;
      ins[3].oninput=e=>it.unit=e.target.value;
      ins[4].oninput=e=>it.relatedItems=e.target.value.split(',').map(s=>s.trim()).filter(Boolean);
      ins.forEach(i=>i.onchange=sync);
      list.appendChild(row);
    });

    const add=document.createElement('button');
    add.className='w-full py-2 border-dashed border-2 rounded';
    add.textContent='新增品項';
    add.onclick=()=>{
      items.push({id:Date.now(),name:'',weekdayMin:0,weekendMin:0,unit:'',relatedItems:[]});
      sync(); render();
    };
    list.appendChild(add);
  }

  wrap.appendChild(list);

  /* 補貨清單 */
  if(page==='inventory'){
    const order = items.map(it=>{
      const min = dayType==='weekday'?it.weekdayMin:it.weekendMin;
      const need = (min||0)-(stockCounts[it.id]||0);
      if(need>0){
        return it.relatedItems?.length ? it.relatedItems.join(', ') : `${it.name} +${need}${it.unit||''}`;
      }
      return null;
    }).filter(Boolean);

    wrap.innerHTML += `
      <div class="mt-4 bg-white p-2 rounded shadow">
        <div class="font-bold mb-1">補貨清單</div>
        ${order.length?order.join('，'):'目前無需補貨'}
        ${order.length?'<button id="copy" class="mt-2 w-full bg-blue-600 text-white py-1 rounded">一鍵複製</button>':''}
      </div>
    `;
    setTimeout(()=>{
      if(document.getElementById('copy')){
        document.getElementById('copy').onclick=()=>{
          navigator.clipboard.writeText(order.join('\n'));
          alert('已複製');
        };
      }
    });
  }

  root.appendChild(wrap);

  /* Events */
  document.getElementById('merchantSel').onchange=e=>{
    currentMerchant=e.target.value; load();
  };
  document.getElementById('merchantMgr').onclick=manageMerchant;
  document.getElementById('togglePage').onclick=()=>{
    page=page==='inventory'?'manage':'inventory'; render();
  };
  if(document.getElementById('clearStock')){
    document.getElementById('clearStock').onclick=()=>{
      if(confirm('確定要清除所有盤點數值？')){
        stockCounts = {};
        sync();
        render();
      }
    };
  }
  if(document.getElementById('wd')) document.getElementById('wd').onclick=()=>{dayType='weekday';render();};
  if(document.getElementById('we')) document.getElementById('we').onclick=()=>{dayType='weekend';render();};
}

/* ========= 功能 ========= */
function adj(id,d){
  stockCounts[id]=(stockCounts[id]||0)+d;
  if(stockCounts[id]<0) stockCounts[id]=0;
  sync(); render();
}

function sync(){
  if(!currentMerchant) return;
  db.ref('inventory_tool/'+currentMerchant).set({items,stockCounts});
}

function load(){
  if(!currentMerchant) return;
  db.ref('inventory_tool/'+currentMerchant).once('value').then(s=>{
    const v=s.val()||{};
    items=v.items||[];
    stockCounts=v.stockCounts||{};
    render();
  });
}

function manageMerchant(){
  const cmd=prompt('新增:商家名 或 刪除:商家名');
  if(!cmd) return;
  const [c,n]=cmd.split(':');
  if(c==='新增' && n && !merchants.includes(n)){
    merchants.push(n); currentMerchant=n;
  }
  if(c==='刪除' && merchants.includes(n)){
    merchants=merchants.filter(m=>m!==n);
    if(currentMerchant===n) currentMerchant=merchants[0]||'';
  }
  render(); load();
}

/* ========= Init ========= */
db.ref('inventory_tool').once('value').then(s=>{
  merchants = s.exists()?Object.keys(s.val()):['預設商家'];
  currentMerchant = merchants[0];
  load();
});
</script>
</body>
</html>
