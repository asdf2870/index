<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>多商家盤點補貨系統</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { font-family: 'Noto Sans TC', sans-serif; background-color:#f8fafc; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance:none;margin:0; }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

// --- Firebase 設定 ---
const firebaseConfig = {
  apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain: "ngdd-8dd14.firebaseapp.com",
  projectId: "ngdd-8dd14",
  storageBucket: "ngdd-8dd14.firebasestorage.app",
  messagingSenderId: "780195335307",
  appId: "1:780195335307:web:c6e95d1e0a7ee92cf3588e",
  databaseURL: "https://ngdd-8dd14-default-rtdb.firebaseio.com"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- Icon 組件 ---
const Icon = ({ name, size = 18, className = "" }) => {
  useEffect(() => {
    if (window.lucide) window.lucide.createIcons({ attrs:{class:className, 'stroke-width':2.5,width:size,height:size}, nameAttr:'data-lucide' });
  }, [name, size, className]);
  return <i data-lucide={name} className={className}></i>;
};

// --- 主 App ---
const App = () => {
  const [loading,setLoading]=useState(true);
  const [merchants,setMerchants]=useState([]);
  const [currentMerchant,setCurrentMerchant]=useState('');
  const [items,setItems]=useState([]);
  const [stockCounts,setStockCounts]=useState({});
  const [dayType,setDayType]=useState('weekday');
  const [showCopySuccess,setShowCopySuccess]=useState(false);

  // 監聽商家列表
  useEffect(()=>{
    db.ref('merchants').on('value',snap=>{
      const val = snap.val()||[];
      setMerchants(val);
      if(!currentMerchant && val.length>0) setCurrentMerchant(val[0]);
    });
    return ()=>db.ref('merchants').off();
  },[]);

  // 監聽當前商家的品項
  useEffect(()=>{
    if(!currentMerchant) return;
    const path = `inventory_tool/${currentMerchant}`;
    db.ref(path).on('value',snap=>{
      const val = snap.val()||{};
      setItems(val.items||[]);
      setStockCounts(val.stockCounts||{});
      setLoading(false);
    });
    return ()=>{ if(currentMerchant) db.ref(`inventory_tool/${currentMerchant}`).off(); }
  },[currentMerchant]);

  // 雲端同步
  const syncToCloud=(newItems,newCounts)=>{
    if(!currentMerchant) return;
    db.ref(`inventory_tool/${currentMerchant}`).update({ items:newItems, stockCounts:newCounts });
  };

  const addMerchant=()=>{
    const name=prompt("輸入新商家名稱");
    if(name && !merchants.includes(name)){
      const newList=[...merchants,name];
      db.ref('merchants').set(newList);
      setCurrentMerchant(name);
    }
  };
  const deleteMerchant=(name)=>{
    if(confirm(`確定刪除商家 "${name}" 及其所有資料？`)){
      const newList=merchants.filter(m=>m!==name);
      db.ref('merchants').set(newList);
      db.ref(`inventory_tool/${name}`).remove();
      if(currentMerchant===name)setCurrentMerchant(newList[0]||'');
    }
  };

  const addItem=()=>{
    const newItem={id:Date.now(),name:'',weekdayMin:0,weekendMin:0,unit:'',shouldRound:false,related:''};
    const updatedItems=[...items,newItem];
    setItems(updatedItems);
    syncToCloud(updatedItems,stockCounts);
  };
  const updateItem=(id,field,value)=>{
    const updatedItems=items.map(i=>i.id===id?{...i,[field]:value}:i);
    setItems(updatedItems);
    syncToCloud(updatedItems,stockCounts);
  };
  const deleteItem=(id)=>{
    if(confirm('確定刪除此品項？')){
      const updatedItems=items.filter(i=>i.id!==id);
      const newCounts={...stockCounts}; delete newCounts[id];
      setItems(updatedItems); setStockCounts(newCounts);
      syncToCloud(updatedItems,newCounts);
    }
  };

  const calculateNeed=(item,curStockStr)=>{
    const cur=parseFloat(curStockStr||0);
    const min=dayType==='weekday'?item.weekdayMin:item.weekendMin;
    let need=min-cur;
    if(need<=0||isNaN(need)) return 0;
    return item.shouldRound?Math.round(need):parseFloat(need.toFixed(2));
  };

  const orderList=useMemo(()=>items.map(i=>{
    const need=calculateNeed(i,stockCounts[i.id]);
    if(need<=0)return null;
    return {name:i.name,need,unit:i.unit,related:i.related||''};
  }).filter(Boolean),[items,stockCounts,dayType]);

  const copyOrder=()=>{
    const label=dayType==='weekday'?'平日':'假日';
    const summary=orderList.map(i=>`${i.name}: ${i.need} ${i.unit} ${i.related}`).join('\n');
    const text=summary?`【${label}補貨清單】\n${summary}`:'無需補貨';
    const ta=document.createElement('textarea');
    ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    setShowCopySuccess(true);
    setTimeout(()=>setShowCopySuccess(false),2000);
  };

  if(loading) return <div className="flex h-screen items-center justify-center text-slate-400 font-bold animate-pulse">盤點資料讀取中...</div>;

  return (
    <div className="min-h-screen flex flex-col max-w-3xl mx-auto bg-white shadow overflow-hidden">
      <header className="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg flex flex-col gap-2">
        <div className="flex justify-between items-center">
          <h1 className="text-lg font-bold">多商家盤點工具</h1>
          <div className="flex gap-2">
            <button onClick={addMerchant} className="bg-blue-600 px-2 py-1 rounded text-white text-xs">新增商家</button>
            {currentMerchant && <button onClick={()=>deleteMerchant(currentMerchant)} className="bg-red-600 px-2 py-1 rounded text-white text-xs">刪除商家</button>}
          </div>
        </div>
        <div className="flex gap-2 overflow-x-auto">
          {merchants.map(m=>(
            <button key={m} onClick={()=>setCurrentMerchant(m)} className={`px-2 py-1 rounded text-xs font-bold ${m===currentMerchant?'bg-slate-700 text-blue-400':'bg-slate-800 text-slate-300'}`}>{m}</button>
          ))}
        </div>
        <div className="flex gap-2 bg-slate-800 p-1 rounded-lg">
          <button onClick={()=>setDayType('weekday')} className={`flex-1 py-1.5 rounded-md text-xs font-bold ${dayType==='weekday'?'bg-slate-700 text-blue-400':'text-slate-500'}`}>平日</button>
          <button onClick={()=>setDayType('weekend')} className={`flex-1 py-1.5 rounded-md text-xs font-bold ${dayType==='weekend'?'bg-slate-700 text-orange-400':'text-slate-500'}`}>假日</button>
        </div>
      </header>

      <main className="flex-1 overflow-y-auto custom-scrollbar p-3">
        {items.map(item=>(
          <div key={item.id} className="p-3 bg-white border border-slate-200 rounded-xl space-y-2 shadow-sm">
            <div className="flex gap-2">
              <input value={item.name} onChange={e=>updateItem(item.id,'name',e.target.value)} placeholder="品項名稱" className="flex-1 border-b border-slate-100 outline-none text-sm"/>
              <input value={item.unit} onChange={e=>updateItem(item.id,'unit',e.target.value)} placeholder="單位" className="w-12 bg-slate-50 rounded text-center text-xs"/>
              <button onClick={()=>deleteItem(item.id)} className="text-red-400 font-bold">×</button>
            </div>
            <div className="flex gap-2">
              <input type="number" value={item.weekdayMin} onChange={e=>updateItem(item.id,'weekdayMin',parseFloat(e.target.value)||0)} placeholder="平日標" className="w-16 p-1 text-xs rounded bg-slate-50 outline-none"/>
              <input type="number" value={item.weekendMin} onChange={e=>updateItem(item.id,'weekendMin',parseFloat(e.target.value)||0)} placeholder="假日標" className="w-16 p-1 text-xs rounded bg-slate-50 outline-none"/>
              <input type="text" value={item.related} onChange={e=>updateItem(item.id,'related',e.target.value)} placeholder="相關品項" className="flex-1 p-1 text-xs rounded bg-slate-50"/>
              <button onClick={()=>updateItem(item.id,'shouldRound',!item.shouldRound)} className={`px-2 py-1 text-[9px] font-bold rounded ${item.shouldRound?'bg-green-100 text-green-600':'bg-slate-100 text-slate-400'}`}>四捨五入</button>
            </div>
          </div>
        ))}
        <button onClick={addItem} className="w-full py-3 mt-2 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold flex items-center justify-center gap-2 text-sm">＋ 新增品項</button>
      </main>

      <footer className="bg-slate-50 border-t border-slate-200 shadow-inner p-3">
        <div className="bg-white border border-slate-200 rounded-lg p-2 max-h-36 overflow-y-auto custom-scrollbar mb-2">
          {orderList.length>0 ? orderList.map((i,idx)=>(
            <div key={idx} className="text-xs text-slate-700 font-medium">{i.name} +{i.need}{i.unit} {i.related}</div>
          )) : <p className="text-[10px] text-center text-slate-300 py-2">目前無缺貨品項</p>}
        </div>
        <button onClick={copyOrder} className={`w-full py-3 rounded-xl font-bold text-white ${showCopySuccess?'bg-green-500':'bg-blue-600'}`}>{showCopySuccess?'已成功複製':'一鍵複製補貨清單'}</button>
      </footer>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
