<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>多商家智能補貨系統</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
body { font-family: 'Noto Sans TC', sans-serif; background-color:#f8fafc; -webkit-tap-highlight-color:transparent; }
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.custom-scrollbar::-webkit-scrollbar{width:4px;}
.custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px;}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

// --- Firebase 初始化 ---
const firebaseConfig = {
  apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain: "ngdd-8dd14.firebaseapp.com",
  projectId: "ngdd-8dd14",
  storageBucket: "ngdd-8dd14.firebasestorage.app",
  messagingSenderId: "780195335307",
  appId: "1:780195335307:web:c6e95d1e0a7ee92cf3588e",
  databaseURL: "https://ngdd-8dd14-default-rtdb.firebaseio.com"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- 小 Icon 元件 ---
const Icon = ({ name, size=18, className="" }) => {
  useEffect(()=>{if(window.lucide)window.lucide.createIcons({attrs:{class:className,'stroke-width':2.5,width:size,height:size},nameAttr:'data-lucide'});},[name,size,className]);
  return <i data-lucide={name} className={className}></i>;
};

// --- 主程式 ---
const App = () => {
  const [mode,setMode]=useState('inventory'); // inventory/settings
  const [dayType,setDayType]=useState('weekday'); // weekday/weekend
  const [merchants,setMerchants]=useState([]); 
  const [currentMerchant,setCurrentMerchant]=useState('');
  const [items,setItems]=useState([]);
  const [stockCounts,setStockCounts]=useState({});
  const [loading,setLoading]=useState(true);
  const [showCopy,setShowCopy]=useState(false);

  // --- 讀取商家列表 ---
  useEffect(()=>{
    const ref=db.ref('merchants');
    ref.on('value',snapshot=>{
      const val=snapshot.val()||{};
      const merchantNames=Object.keys(val);
      setMerchants(merchantNames);
      if(!currentMerchant && merchantNames.length>0) setCurrentMerchant(merchantNames[0]);
    });
    return ()=>ref.off();
  },[]);

  // --- 監聽目前商家資料 ---
  useEffect(()=>{
    if(!currentMerchant) return;
    setLoading(true);
    const ref=db.ref(`inventory_tool/${currentMerchant}`);
    ref.on('value',snapshot=>{
      const val=snapshot.val()||{};
      setItems(val.items||[]);
      setStockCounts(val.stockCounts||{});
      setLoading(false);
    });
    return ()=>{if(currentMerchant) db.ref(`inventory_tool/${currentMerchant}`).off();};
  },[currentMerchant]);

  // --- 同步雲端 ---
  const syncToCloud=(newItems,newCounts)=>{
    if(!currentMerchant) return;
    db.ref(`inventory_tool/${currentMerchant}`).update({items:newItems,stockCounts:newCounts});
  };

  // --- 商家操作 ---
  const addMerchant=()=>{
    const name=prompt('請輸入新商家名稱');
    if(name){
      db.ref(`merchants/${name}`).set(true);
      setCurrentMerchant(name);
    }
  };
  const deleteMerchant=(name)=>{
    if(confirm(`確定刪除商家 ${name}？`)){
      db.ref(`merchants/${name}`).remove();
      if(currentMerchant===name) setCurrentMerchant(merchants[0]||'');
    }
  };

  // --- 品項操作 ---
  const addItem=()=>{
    const newItem={id:Date.now(),name:'',weekdayMin:0,weekendMin:0,unit:'',shouldRound:false,related:[]};
    const updated=[...items,newItem];
    setItems(updated);
    syncToCloud(updated,stockCounts);
    setMode('settings');
  };
  const updateItem=(id,field,value)=>{
    const updated=items.map(i=>i.id===id?{...i,[field]:value}:i);
    setItems(updated);
    syncToCloud(updated,stockCounts);
  };
  const deleteItem=(id)=>{
    if(confirm('確定刪除此品項？')){
      const updated=items.filter(i=>i.id!==id);
      const newCounts={...stockCounts}; delete newCounts[id];
      setItems(updated); setStockCounts(newCounts); syncToCloud(updated,newCounts);
    }
  };

  const calculateNeed=(item,currentStockStr)=>{
    const current=parseFloat(currentStockStr||0);
    const min=dayType==='weekday'?item.weekdayMin:item.weekendMin;
    let need=min-current;
    if(need<=0||isNaN(need)) return 0;
    return item.shouldRound?Math.round(need):parseFloat(need.toFixed(2));
  };

  // --- 智能補貨清單（包含相關品項累加） ---
  const orderList=useMemo(()=>{
    const map={};
    items.forEach(item=>{
      const need=calculateNeed(item,stockCounts[item.id]);
      if(need>0){
        if(!map[item.name]) map[item.name]={need:0,unit:item.unit};
        map[item.name].need+=need;
        (item.related||[]).forEach(rel=>{
          if(!map[rel]) map[rel]={need:0,unit:''};
          map[rel].need+=need;
        });
      }
    });
    return Object.entries(map).map(([name,v])=>({name,need:v.need,unit:v.unit}));
  },[items,stockCounts,dayType]);

  const copyOrder=()=>{
    const label=dayType==='weekday'?'平日':'假日';
    const summary=orderList.map(i=>`${i.name}: ${i.need} ${i.unit}`).join('\n');
    const text=summary?`【${label}補貨清單】\n${summary}`:'無需補貨';
    const ta=document.createElement('textarea'); ta.value=text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    setShowCopy(true); setTimeout(()=>setShowCopy(false),2000);
  };

  const clearCounts=()=>{
    if(confirm('確定要清空目前所有輸入的數值嗎？')){
      setStockCounts({});
      syncToCloud(items,{});
    }
  };

  if(loading) return <div className="flex h-screen items-center justify-center text-slate-400 font-bold animate-pulse">資料讀取中...</div>;

  return (
    <div className="min-h-screen flex flex-col max-w-3xl mx-auto bg-white shadow-xl overflow-hidden">
      <header className="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg">
        <div className="flex justify-between items-center mb-2">
          <h1 className="text-lg font-bold">多商家智能補貨系統</h1>
          <div className="flex gap-2">
            <button onClick={addMerchant} className="px-2 py-1 bg-green-500 rounded text-white text-xs">新增商家</button>
          </div>
        </div>
        <div className="flex gap-2 items-center mb-2">
          <select value={currentMerchant} onChange={e=>setCurrentMerchant(e.target.value)} className="p-1 rounded border border-slate-300">
            {merchants.map(m=><option key={m} value={m}>{m}</option>)}
          </select>
          {currentMerchant && <button onClick={()=>deleteMerchant(currentMerchant)} className="px-2 py-1 bg-red-500 text-white rounded text-xs">刪除商家</button>}
        </div>
        <div className="flex bg-slate-800 p-1 rounded-lg">
          <button onClick={()=>setDayType('weekday')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${dayType==='weekday'?'bg-slate-700 text-blue-400':'text-slate-500'}`}>平日</button>
          <button onClick={()=>setDayType('weekend')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${dayType==='weekend'?'bg-slate-700 text-orange-400':'text-slate-500'}`}>假日</button>
        </div>
      </header>

      <main className="flex-1 overflow-y-auto custom-scrollbar p-3">
        {mode==='inventory'?(
          <div className="divide-y divide-slate-100">
            {items.length===0?(
              <div className="py-20 text-center text-slate-400 text-sm italic">請點擊右上管理新增品項</div>
            ):(
              items.map(item=>{
                const need=calculateNeed(item,stockCounts[item.id]);
                return (
                  <div key={item.id} className={`py-3 flex items-center gap-3 ${need>0?'bg-orange-50/30':''}`}>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className={`font-bold text-sm truncate ${need>0?'text-orange-700':'text-slate-700'}`}>{item.name}</span>
                        <span className="text-[10px] text-slate-400 whitespace-nowrap">標: {dayType==='weekday'?item.weekdayMin:item.weekendMin}</span>
                      </div>
                    </div>
                    <div className="flex items-center gap-2 w-48 justify-end">
                      <div className="relative w-24">
                        <input type="number" inputMode="decimal" placeholder="現存" value={stockCounts[item.id]||''}
                          onChange={e=>{const newCounts={...stockCounts,[item.id]:e.target.value};setStockCounts(newCounts);syncToCloud(items,newCounts);}}
                          className="w-full bg-slate-100 border-none rounded-lg py-1.5 px-2 text-right text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                        <span className="absolute left-2 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 font-bold">{item.unit}</span>
                      </div>
                      <div className={`w-14 text-center font-black text-sm ${need>0?'text-red-500':'text-slate-200'}`}>{need>0?`+${need}`:'OK'}</div>
                    </div>
                  </div>
                )
              })
            )}
          </div>
        ):(
          <div className="space-y-3 pb-10">
            {items.map(item=>(
              <div key={item.id} className="p-3 bg-white border border-slate-200 rounded-xl space-y-2 relative shadow-sm">
                <div className="flex gap-2">
                  <input value={item.name} onChange={e=>updateItem(item.id,'name',e.target.value)} placeholder="品項名稱" className="flex-1 font-bold border-b border-slate-100 focus:border-blue-500 outline-none text-sm"/>
                  <input value={item.unit} onChange={e=>updateItem(item.id,'unit',e.target.value)} placeholder="單位" className="w-12 bg-slate-50 rounded text-center text-xs p-1 outline-none"/>
                  <button onClick={()=>deleteItem(item.id)} className="text-slate-300 active:text-red-500"><Icon name="trash-2" size={14}/></button>
                </div>
                <div className="flex items-center gap-4">
                  <div className="flex-1 flex gap-2">
                    <div className="flex-1">
                      <span className="text-[9px] text-blue-500 font-bold block">平日標</span>
                      <input type="number" value={item.weekdayMin} onChange={e=>updateItem(item.id,'weekdayMin',parseFloat(e.target.value)||0)} className="w-full bg-slate-50 rounded p-1 text-xs font-bold outline-none"/>
                    </div>
                    <div className="flex-1">
                      <span className="text-[9px] text-orange-500 font-bold block">假日標</span>
                      <input type="number" value={item.weekendMin} onChange={e=>updateItem(item.id,'weekendMin',parseFloat(e.target.value)||0)} className="w-full bg-slate-50 rounded p-1 text-xs font-bold outline-none"/>
                    </div>
                  </div>
                  <button onClick={()=>updateItem(item.id,'shouldRound',!item.shouldRound)} className={`px-2 py-1 rounded text-[9px] font-bold transition-all ${item.shouldRound?'bg-green-100 text-green-600 ring-1 ring-green-200':'bg-slate-100 text-slate-400'}`}>四捨五入</button>
                </div>
                <div className="mt-1">
                  <span className="text-[9px] text-purple-500 font-bold block mb-1">相關品項（用逗號分隔）</span>
                  <input type="text" value={item.related.join(',')} onChange={e=>updateItem(item.id,'related',e.target.value.split(',').map(s=>s.trim()))} className="w-full bg-slate-50 rounded p-1 text-xs outline-none"/>
                </div>
              </div>
            ))}
            <button onClick={addItem} className="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold flex items-center justify-center gap-2 text-sm"><Icon name="plus" size={16}/> 新增品項</button>
          </div>
        )}
      </main>

      {mode==='inventory' && <footer className="bg-slate-50 border-t border-slate-200 shadow-inner">
        <div className="px-4 py-3">
          <div className="bg-white border border-slate-200 rounded-lg p-2 max-h-32 overflow-y-auto custom-scrollbar mb-3">
            {orderList.length>0?(
              <div className="flex flex-wrap gap-x-3 gap-y-1">
                {orderList.map((i,idx)=><span key={idx} className="text-xs text-slate-700 font-medium">{i.name} <span className="text-red-500 font-bold">+{i.need}</span>{i.unit}</span>)}
              </div>
            ):(<p className="text-[10px] text-center text-slate-300 py-2">目前無缺貨品項</p>)}
          </div>
          <button onClick={copyOrder} disabled={orderList.length===0} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all flex items-center justify-center gap-2 active:scale-95 ${showCopy? 'bg-green-500' : (orderList.length>0? (dayType==='weekday'?'bg-blue-600':'bg-orange-600'):'bg-slate-300')}`}><Icon name={showCopy?'check':'copy'} size={16}/>{showCopy?'已成功複製':'一鍵複製補貨清單'}</button>
        </div>
      </footer>}
    </div>
  );
};

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
