<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å¤šå•†å®¶ç›¤é»è£œè²¨ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-4">
<div class="max-w-4xl mx-auto space-y-4">

<h1 class="text-2xl font-bold">ğŸ“¦ å¤šå•†å®¶ç›¤é»è£œè²¨ç³»çµ±</h1>

<!-- å•†å®¶ -->
<div class="flex gap-2">
  <select id="merchantSelect" class="border p-2 flex-1"></select>
  <button id="addMerchant" class="bg-blue-600 text-white px-3">ï¼‹å•†å®¶</button>
  <button id="delMerchant" class="bg-red-600 text-white px-3">åˆªé™¤</button>
</div>

<!-- å¹³å‡æ—¥ -->
<div class="flex gap-4">
  <label><input type="radio" name="day" value="weekday" checked> å¹³æ—¥</label>
  <label><input type="radio" name="day" value="weekend"> å‡æ—¥</label>
</div>

<!-- ç›¤é» -->
<div id="items" class="space-y-3"></div>

<!-- è£œè²¨æ¸…å–® -->
<div class="bg-yellow-50 p-3 rounded shadow">
  <div class="flex justify-between mb-2">
    <h2 class="font-bold">ğŸ§¾ è£œè²¨æ¸…å–®</h2>
    <button id="copyOrder" class="bg-gray-700 text-white px-2 text-sm">ğŸ“‹ è¤‡è£½</button>
  </div>
  <pre id="orderList"></pre>
</div>

<!-- æ–°å¢å“é … -->
<div class="bg-white p-3 rounded shadow space-y-2">
  <h2 class="font-bold">â• æ–°å¢å“é …</h2>
  <input id="newName" class="border p-1 w-full" placeholder="å“é …åç¨±">
  <input id="newUnit" class="border p-1 w-full" placeholder="å–®ä½">
  <input id="newW" type="number" class="border p-1 w-full" placeholder="å¹³æ—¥æœ€ä½">
  <input id="newH" type="number" class="border p-1 w-full" placeholder="å‡æ—¥æœ€ä½">
  <textarea id="newLinks" class="border p-1 w-full" placeholder="é—œè¯é£Ÿæï¼šåç¨±,å–®ä½,æ•¸é‡"></textarea>
  <button id="addItem" class="bg-green-600 text-white px-3 py-1">æ–°å¢</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain: "ngdd-8dd14.firebaseapp.com",
  databaseURL: "https://ngdd-8dd14-default-rtdb.firebaseio.com",
  projectId: "ngdd-8dd14"
});
const db = getDatabase(app);

let merchant = null;
let items = {};
let stocks = {};
let day = "weekday";

const merchantSelect = document.getElementById("merchantSelect");

onValue(ref(db,"merchants"),s=>{
  merchantSelect.innerHTML="";
  s.forEach(c=>{
    let o=document.createElement("option");
    o.value=c.key;o.textContent=c.val().name;
    merchantSelect.appendChild(o);
  });
  if(!merchant&&merchantSelect.value){
    merchant=merchantSelect.value;load();
  }
});

merchantSelect.onchange=()=>{merchant=merchantSelect.value;load();};

document.getElementsByName("day").forEach(r=>{
  r.onchange=e=>{day=e.target.value;render();}
});

function load(){
  onValue(ref(db,`data/${merchant}/items`),s=>{items=s.val()||{};render();});
  onValue(ref(db,`data/${merchant}/stocks`),s=>{stocks=s.val()||{};render();});
}

document.getElementById("addMerchant").onclick=()=>{
  const n=prompt("å•†å®¶åç¨±"); if(!n)return;
  set(ref(db,"merchants/m_"+Date.now()),{name:n});
};

document.getElementById("delMerchant").onclick=()=>{
  if(confirm("åˆªé™¤å•†å®¶ï¼Ÿ")){
    remove(ref(db,"merchants/"+merchant));
    remove(ref(db,"data/"+merchant));
  }
};

document.getElementById("addItem").onclick=()=>{
  const links=newLinks.value.split("\n").filter(Boolean).map(l=>{
    const[a,b,c]=l.split(",");return{name:a,unit:b,qty:+c};
  });
  push(ref(db,`data/${merchant}/items`),{
    name:newName.value,unit:newUnit.value,
    weekdayMin:+newW.value,weekendMin:+newH.value,
    links
  });
  newName.value=newUnit.value=newW.value=newH.value=newLinks.value="";
};

function render(){
  const box=document.getElementById("items");
  box.innerHTML="";
  let orderMap={};

  Object.entries(items).forEach(([id,it])=>{
    const min=day==="weekday"?it.weekdayMin:it.weekendMin;
    const cur=stocks[id]||0;
    const need=Math.max(0,min-cur);

    const d=document.createElement("div");
    d.className="bg-white p-2 rounded shadow space-y-1";
    d.innerHTML=`
      <input value="${it.name}" class="border p-1 w-full">
      <input value="${it.unit}" class="border p-1 w-full">
      <button class="text-red-500 text-sm">åˆªé™¤</button>
      <input type="number" value="${cur}" class="border p-1 w-full">
    `;
    const [n,u,del,inp]=d.querySelectorAll("input,button");
    n.oninput=e=>update(ref(db,`data/${merchant}/items/${id}`),{name:e.target.value});
    u.oninput=e=>update(ref(db,`data/${merchant}/items/${id}`),{unit:e.target.value});
    del.onclick=()=>confirm("åˆªé™¤å“é …ï¼Ÿ")&&remove(ref(db,`data/${merchant}/items/${id}`));
    inp.oninput=e=>set(ref(db,`data/${merchant}/stocks/${id}`),+e.target.value);
    box.appendChild(d);

    if(need>0){
      (it.links||[]).forEach(l=>{
        const k=l.name+l.unit;
        orderMap[k]=(orderMap[k]||0)+l.qty*need;
      });
    }
  });

  orderList.textContent=Object.entries(orderMap)
    .map(([k,v])=>`${k} +${v}`).join("\n")||"ç›®å‰ç„¡éœ€è£œè²¨";
}

copyOrder.onclick=()=>navigator.clipboard.writeText(orderList.textContent);
</script>
</body>
</html>
