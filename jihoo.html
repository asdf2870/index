<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盤點叫貨系統 - 多商家</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f8fafc; }
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
</style>
</head>
<body>

<div id="root" class="p-4 max-w-xl mx-auto"></div>

<script>
/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey: "AIzaSyCu_W2qzTZTMm0cOh1Gc7ys8uDKJEkzD7M",
  authDomain: "all-sun-e7472.firebaseapp.com",
  databaseURL: "https://all-sun-e7472-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "all-sun-e7472",
  storageBucket: "all-sun-e7472.firebasestorage.app",
  messagingSenderId: "679291601652",
  appId: "1:679291601652:web:af747f74bdb9afe0bc94a1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========= 狀態 ========= */
let merchants = [];
let currentMerchant = '';
let items = [];
let stockCounts = {};
let dayType = 'weekday';
let managementMode = false;

const root = document.getElementById('root');

/* ========= Render ========= */
function render() {
  root.innerHTML = '';
  const wrap = document.createElement('div');

  /* 商家切換 + 管理 */
  wrap.innerHTML += `
    <div class="flex gap-2 mb-4">
      <select id="merchantSelect" class="border rounded px-2 py-1 flex-1">
        ${merchants.map(m => `<option ${m===currentMerchant?'selected':''}>${m}</option>`).join('')}
      </select>
      <button id="merchantManage" class="px-3 py-1 bg-slate-600 text-white rounded">商家管理</button>
    </div>
  `;

  /* 標題 */
  wrap.innerHTML += `
    <div class="flex justify-between items-center mb-3">
      <h1 class="text-xl font-bold">盤點叫貨系統</h1>
      <button id="toggleManage" class="px-3 py-1 bg-blue-600 text-white rounded">
        ${managementMode ? '完成' : '管理品項'}
      </button>
    </div>
  `;

  /* 平假日 */
  wrap.innerHTML += `
    <div class="flex gap-2 mb-4">
      <button id="weekday" class="flex-1 py-1 rounded ${dayType==='weekday'?'bg-blue-600 text-white':'bg-slate-200'}">平日</button>
      <button id="weekend" class="flex-1 py-1 rounded ${dayType==='weekend'?'bg-orange-500 text-white':'bg-slate-200'}">假日</button>
    </div>
  `;

  /* 品項列表 */
  const list = document.createElement('div');
  list.className = 'space-y-2';

  items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'flex items-center gap-2 bg-white p-2 rounded shadow';

    if (managementMode) {
      row.innerHTML = `
        <input class="flex-1 border-b" value="${item.name}" placeholder="品項名稱">
        <input class="w-16 border-b text-center" placeholder="單位" value="${item.unit||''}">
        <button class="text-red-500">刪</button>
      `;
      row.querySelectorAll('input')[0].oninput = e => { item.name = e.target.value; sync(); };
      row.querySelectorAll('input')[1].oninput = e => { item.unit = e.target.value; sync(); };
      row.querySelector('button').onclick = () => {
        if(confirm('確定刪除？')) {
          items = items.filter(i => i.id !== item.id);
          delete stockCounts[item.id];
          sync(); render();
        }
      };
    } else {
      row.innerHTML = `
        <span class="flex-1">${item.name}</span>
        <button class="px-2" onclick="adjust('${item.id}',-0.5)">−</button>
        <input type="number" step="0.5" class="w-20 text-center border rounded"
          value="${stockCounts[item.id]||0}">
        <span class="text-sm text-slate-400">${item.unit||''}</span>
        <button class="px-2" onclick="adjust('${item.id}',0.5)">＋</button>
      `;
      row.querySelector('input').oninput = e => {
        stockCounts[item.id] = parseFloat(e.target.value)||0;
        sync(); render();
      };
    }
    list.appendChild(row);
  });

  wrap.appendChild(list);

  /* 新增品項 */
  if (managementMode) {
    const btn = document.createElement('button');
    btn.className = 'mt-3 w-full border-dashed border-2 py-2 rounded';
    btn.innerText = '新增品項';
    btn.onclick = () => {
      items.push({ id: Date.now().toString(), name:'', unit:'', weekdayMin:0, weekendMin:0 });
      sync(); render();
    };
    wrap.appendChild(btn);
  }

  /* 補貨清單 */
  const order = document.createElement('div');
  order.className = 'mt-5 p-3 bg-white rounded shadow';
  order.innerHTML = `<h2 class="font-bold mb-2">需備料清單</h2>`;

  const listNeed = items.map(i => {
    const now = stockCounts[i.id]||0;
    const min = dayType==='weekday'?i.weekdayMin:i.weekendMin;
    const need = min - now;
    if (need > 0) return `${i.name} +${need} ${i.unit||''}`;
    return null;
  }).filter(Boolean);

  if (listNeed.length === 0) {
    order.innerHTML += `<p class="text-sm text-slate-400">目前無需補貨</p>`;
  } else {
    order.innerHTML += `<pre class="text-sm whitespace-pre-line">${listNeed.join('\n')}</pre>`;
    const copy = document.createElement('button');
    copy.className = 'mt-2 w-full py-2 bg-blue-600 text-white rounded';
    copy.innerText = '一鍵複製補貨清單';
    copy.onclick = () => {
      navigator.clipboard.writeText(listNeed.join('\n'));
      alert('已複製');
    };
    order.appendChild(copy);
  }

  wrap.appendChild(order);
  root.appendChild(wrap);

  /* 事件 */
  document.getElementById('merchantSelect').onchange = e => {
    currentMerchant = e.target.value;
    load();
  };
  document.getElementById('merchantManage').onclick = manageMerchant;
  document.getElementById('toggleManage').onclick = () => { managementMode=!managementMode; render(); };
  document.getElementById('weekday').onclick = ()=>{dayType='weekday';render();};
  document.getElementById('weekend').onclick = ()=>{dayType='weekend';render();};
}

/* ========= 功能 ========= */
function adjust(id, d){
  stockCounts[id]=(stockCounts[id]||0)+d;
  if(stockCounts[id]<0) stockCounts[id]=0;
  sync(); render();
}

function sync(){
  if(!currentMerchant) return;
  db.ref('inventory/'+currentMerchant).set({items,stockCounts});
}

function load(){
  db.ref('inventory/'+currentMerchant).once('value').then(s=>{
    const v=s.val()||{};
    items=v.items||[];
    stockCounts=v.stockCounts||{};
    render();
  });
}

function manageMerchant(){
  const act = prompt('新增:商家名 / 修改:舊名>新名 / 刪除:商家名');
  if(!act) return;
  if(act.startsWith('新增:')){
    merchants.push(act.slice(3));
  }else if(act.startsWith('刪除:')){
    merchants = merchants.filter(m=>m!==act.slice(3));
  }else if(act.startsWith('修改:')){
    const [o,n]=act.slice(3).split('>');
    merchants = merchants.map(m=>m===o?n:m);
    if(currentMerchant===o) currentMerchant=n;
  }
  saveMerchants();
}

function saveMerchants(){
  db.ref('merchants').set(merchants);
  loadMerchants();
}

function loadMerchants(){
  db.ref('merchants').once('value').then(s=>{
    merchants = s.val() || ['預設商家'];
    currentMerchant = merchants[0];
    load();
  });
}

/* ========= 啟動 ========= */
loadMerchants();
</script>

</body>
</html>
