<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能排班系統 - 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #F8FAFC; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        th, td { border: 1px solid #f1f5f9; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
            authDomain: "order-718b1.firebaseapp.com",
            projectId: "order-718b1",
            storageBucket: "order-718b1.firebasestorage.app",
            messagingSenderId: "454465000018",
            appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
            databaseURL: "https://order-718b1-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const ADMIN_PASSCODE = "0418";

        const parseShiftTime = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string') return { start: 0, end: 0, hours: 0 };
            const parts = timeStr.split('-');
            if (parts.length !== 2) return { start: 0, end: 0, hours: 0 };
            const toDec = (s) => {
                if (s.includes(':')) {
                    const [h, m] = s.split(':').map(Number);
                    return h + (m / 60);
                }
                return Number(s);
            };
            let start = toDec(parts[0]);
            let end = toDec(parts[1]);
            if (end < start) end += 24; 
            return { start, end, hours: end - start };
        };

        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const weekNames = ['一', '二', '三', '四', '五', '六', '日'];
        const getWeekdayIndex = (year, month, day) => {
            let dayOfWeek = new Date(year, month, day).getDay(); 
            return dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
        };

        const App = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('admin-view');
            const [isLocked, setIsLocked] = useState(true); 
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authPassword, setAuthPassword] = useState("");
            const [loading, setLoading] = useState(true);
            const [customTime, setCustomTime] = useState("");
            const [hideUnavail, setHideUnavail] = useState(false);

            const [staff, setStaff] = useState([]);
            const [unavailabilities, setUnavailabilities] = useState({});
            const [schedules, setSchedules] = useState({});
            const [popover, setPopover] = useState(null); 
            const [editingStaff, setEditingStaff] = useState(null);

            // 1. 監聽 Firebase 雲端資料
            useEffect(() => {
                const dataRef = db.ref('shift_system');
                dataRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setStaff(data.staff || []);
                        setUnavailabilities(data.unavailabilities || {});
                        setSchedules(data.schedules || {});
                    } else {
                        // 初始化預設資料
                        const initialStaff = [{ id: '1', name: '店長', type: 'full-time', shifts: ['morning', 'evening'], position: '管理員', order: 1 }];
                        setStaff(initialStaff);
                    }
                    setLoading(false);
                });
                return () => dataRef.off();
            }, []);

            // 2. 雲端同步函式
            const syncToCloud = (newStaff, newUnavail, newSched) => {
                db.ref('shift_system').set({
                    staff: newStaff,
                    unavailabilities: newUnavail,
                    schedules: newSched
                });
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysCount = getDaysInMonth(year, month);
            const dates = Array.from({ length: daysCount }, (_, i) => i + 1);
            const sortedStaff = [...staff].sort((a, b) => (a.order || 99) - (b.order || 99));

            const statistics = useMemo(() => {
                const stats = {};
                sortedStaff.forEach(s => {
                    let totalHours = 0;
                    let scheduledDays = 0;
                    dates.forEach(d => {
                        const shift = schedules[`${s.id}-${d}`];
                        if (shift) {
                            totalHours += parseShiftTime(shift).hours;
                            scheduledDays++;
                        }
                    });
                    stats[s.id] = { hours: totalHours.toFixed(1), unscheduled: daysCount - scheduledDays };
                });
                return stats;
            }, [schedules, sortedStaff, daysCount]);

            const handleAuthSubmit = () => {
                if (authPassword === ADMIN_PASSCODE) {
                    setIsLocked(false);
                    setShowAuthModal(false);
                    setAuthPassword("");
                } else { alert("密碼錯誤！"); }
            };

            const checkConflict = (staffId, date, shiftStr) => {
                if (!shiftStr) return false;
                const key = `${staffId}-${year}-${month}-${date}`;
                const unavail = unavailabilities[key];
                if (!unavail) return false;
                if (unavail.types?.includes('全天休')) return true;
                const { start, end } = parseShiftTime(shiftStr);
                if (unavail.types?.includes('早休') && start < 16) return true;
                if (unavail.types?.includes('晚休') && (start < 20 && end > 16)) return true;
                if (unavail.types?.includes('夜休') && end > 23) return true;
                return false;
            };

            const getUnavailDisplayData = (data) => {
                if (!data || hideUnavail) return null;
                let textParts = [];
                if (data.types?.includes('全天休')) return { text: '全休', bg: 'rgba(71, 85, 105, 0.9)', color: '#fff', isFull: true };
                const typeMap = { '早休': '早', '晚休': '晚', '夜休': '夜' };
                if (data.types) textParts.push(data.types.map(t => typeMap[t] || t).join('/'));
                if (textParts.length === 0 && !data.note) return null;
                return { text: textParts.join('\n') || '有備註', bg: 'rgba(254, 226, 226, 0.6)', color: '#dc2626' };
            };

            const SHIFT_OPTIONS = {
                'morning': ['08-14', '08-16', '10-17', '10-16'],
                'evening': ['16-23', '17-23', '18-23', '12-20'],
                'night': ['23-05', '00-08']
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-black text-slate-400">雲端資料同步中...</div>;

            return (
                <div className="min-h-screen bg-[#F8FAFC] text-slate-900 pb-20">
                    {/* 原有導覽列 UI */}
                    <nav className="bg-white border-b border-slate-100 px-6 py-4 sticky top-0 z-[100] flex flex-wrap gap-4 justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><Icon name="calendar" size={20}/></div>
                            <div><h1 className="font-black text-lg tracking-tight text-slate-800">智能排班系統</h1><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Cloud Sync</p></div>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-2xl">
                            {[['staff-view', '員工畫休'], ['admin-view', '管理排班'], ['staff-manage', '人員名單']].map(([v, n]) => (
                                <button key={v} onClick={() => setView(v)} className={`px-5 py-2 rounded-xl text-xs font-black transition-all ${view === v ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>{n}</button>
                            ))}
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={() => isLocked ? setShowAuthModal(true) : setIsLocked(true)} className={`flex items-center gap-2 px-5 py-2.5 rounded-2xl font-black text-xs border shadow-sm transition-all ${isLocked ? 'bg-rose-50 text-rose-500 border-rose-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`}>
                                <Icon name={isLocked ? 'lock' : 'unlock'} size={14}/> {isLocked ? '管理鎖定' : '已解鎖'}
                            </button>
                        </div>
                    </nav>

                    {/* 統計列 */}
                    {view === 'admin-view' && (
                        <div className="bg-indigo-900 text-white px-6 py-3 flex overflow-x-auto gap-6 no-scrollbar sticky top-[73px] z-[90]">
                            <div className="flex items-center gap-2 whitespace-nowrap"><Icon name="clock" size={14} className="text-indigo-300"/><span className="text-xs font-black">本月統計：</span></div>
                            {sortedStaff.map(s => (
                                <div key={s.id} className="flex items-center gap-2 whitespace-nowrap bg-indigo-800/50 px-3 py-1 rounded-lg">
                                    <span className="text-[11px] font-black text-indigo-100">{s.name}</span>
                                    <span className="text-[11px] font-black bg-indigo-500 px-1.5 rounded">{statistics[s.id]?.hours}h</span>
                                </div>
                            ))}
                        </div>
                    )}

                    <main className="p-6">
                        {view === 'admin-view' && (
                            <div className="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden p-2">
                                <div className="overflow-x-auto">
                                    <table className="w-full border-separate border-spacing-0">
                                        <thead>
                                            <tr className="bg-slate-50">
                                                <th className="p-4 border-b border-r border-slate-100 sticky left-0 z-30 bg-slate-50 min-w-[120px] font-black text-xs">員工</th>
                                                {dates.map(d => (
                                                    <th key={d} className="p-2 border-b border-r border-slate-100 min-w-[60px] text-center">
                                                        <div className="text-sm font-black text-slate-800">{d}</div>
                                                        <div className="text-[10px] text-slate-400 font-bold">{weekNames[getWeekdayIndex(year, month, d)]}</div>
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {sortedStaff.map(s => (
                                                <tr key={s.id}>
                                                    <td className="p-3 border-b border-r border-slate-100 sticky left-0 z-20 bg-white font-black text-sm text-center">{s.name}</td>
                                                    {dates.map(d => {
                                                        const shift = schedules[`${s.id}-${d}`];
                                                        const unavail = getUnavailDisplayData(unavailabilities[`${s.id}-${year}-${month}-${d}`]);
                                                        const isConflict = checkConflict(s.id, d, shift);
                                                        return (
                                                            <td key={d} onClick={() => !isLocked && setPopover({ type: 'sched', staff: s, date: d })} 
                                                                className={`border-b border-r border-slate-100 h-12 text-center relative ${shift ? 'bg-indigo-50' : (unavail?.isFull ? 'bg-slate-600' : '')}`}>
                                                                {shift ? <span className={`text-xs font-black ${isConflict ? 'text-rose-600 underline' : 'text-indigo-600'}`}>{shift}</span> : (unavail && <span className="text-[8px] text-rose-500 font-bold">{unavail.text}</span>)}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'staff-manage' && (
                            <div className="max-w-4xl mx-auto space-y-4">
                                {!isLocked && <button onClick={() => setEditingStaff({ id: Date.now().toString(), name: '', type: 'full-time', shifts: ['morning', 'evening'], position: '店員', order: staff.length + 1 })} className="w-full py-4 bg-indigo-600 text-white rounded-3xl font-black shadow-lg">新增人員</button>}
                                {sortedStaff.map(s => (
                                    <div key={s.id} className="bg-white p-6 rounded-[2rem] border border-slate-100 flex justify-between items-center">
                                        <div className="font-black text-lg">{s.name} <span className="text-xs text-slate-400 font-bold ml-2">{s.position}</span></div>
                                        {!isLocked && (
                                            <div className="flex gap-2">
                                                <button onClick={() => setEditingStaff(s)} className="p-3 text-indigo-600"><Icon name="edit-3"/></button>
                                                <button onClick={() => { if(confirm('刪除？')) syncToCloud(staff.filter(i=>i.id!==s.id), unavailabilities, schedules) }} className="p-3 text-rose-500"><Icon name="trash-2"/></button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'staff-view' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                {sortedStaff.map(s => (
                                    <div key={s.id} className="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm p-6">
                                        <h3 className="font-black text-lg mb-4 text-indigo-600">{s.name} - 畫休</h3>
                                        <div className="grid grid-cols-7 gap-1">
                                            {dates.map(d => {
                                                const key = `${s.id}-${year}-${month}-${d}`;
                                                const isOff = unavailabilities[key]?.types?.includes('全天休');
                                                return (
                                                    <button key={d} onClick={() => {
                                                        const newUnavail = {...unavailabilities, [key]: {types: isOff ? [] : ['全天休']}};
                                                        syncToCloud(staff, newUnavail, schedules);
                                                    }} className={`aspect-square rounded-xl border text-[10px] font-black ${isOff ? 'bg-rose-500 text-white border-rose-600' : 'bg-slate-50 border-slate-100'}`}>
                                                        {d}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* 彈出視窗：排班 */}
                    {popover?.type === 'sched' && (
                        <div className="fixed inset-0 z-[500] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-[340px] shadow-2xl">
                                <h4 className="text-xl font-black text-center mb-6">{popover.staff.name} ({popover.date}日)</h4>
                                <div className="grid grid-cols-2 gap-2">
                                    {popover.staff.shifts?.map(cat => SHIFT_OPTIONS[cat].map(opt => (
                                        <button key={opt} onClick={() => { 
                                            const newSched = {...schedules, [`${popover.staff.id}-${popover.date}`]: opt};
                                            syncToCloud(staff, unavailabilities, newSched);
                                            setPopover(null);
                                        }} className="py-3 bg-slate-50 rounded-xl font-black text-xs border border-transparent hover:border-indigo-200">{opt}</button>
                                    )))}
                                </div>
                                <button onClick={() => {
                                    const newSched = {...schedules}; delete newSched[`${popover.staff.id}-${popover.date}`];
                                    syncToCloud(staff, unavailabilities, newSched); setPopover(null);
                                }} className="w-full mt-6 text-rose-500 font-black text-xs">清除排班</button>
                                <button onClick={() => setPopover(null)} className="w-full mt-2 text-slate-400 font-black text-xs">關閉</button>
                            </div>
                        </div>
                    )}

                    {/* 彈出視窗：編輯人員 */}
                    {editingStaff && (
                        <div className="fixed inset-0 z-[500] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm space-y-4">
                                <h3 className="font-black text-xl">編輯人員資料</h3>
                                <input placeholder="姓名" className="w-full p-4 bg-slate-50 rounded-2xl font-black outline-none" value={editingStaff.name} onChange={e=>setEditingStaff({...editingStaff, name:e.target.value})} />
                                <input placeholder="職位" className="w-full p-4 bg-slate-50 rounded-2xl font-black outline-none" value={editingStaff.position} onChange={e=>setEditingStaff({...editingStaff, position:e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={() => setEditingStaff(null)} className="flex-1 py-4 text-slate-400 font-black">取消</button>
                                    <button onClick={() => {
                                        const newStaff = staff.some(s=>s.id===editingStaff.id) ? staff.map(s=>s.id===editingStaff.id?editingStaff:s) : [...staff, editingStaff];
                                        syncToCloud(newStaff, unavailabilities, schedules); setEditingStaff(null);
                                    }} className="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black">儲存</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 管理鎖定 Modal */}
                    {showAuthModal && (
                        <div className="fixed inset-0 z-[1000] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm text-center shadow-2xl">
                                <Icon name="lock" size={32} className="text-indigo-600 mx-auto mb-4" />
                                <h3 className="text-xl font-black mb-6">管理員解鎖</h3>
                                <input type="password" autoFocus className="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 text-center text-3xl font-black outline-none focus:border-indigo-500 mb-6" value={authPassword} onChange={e => setAuthPassword(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAuthSubmit()} />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowAuthModal(false)} className="flex-1 py-4 font-black text-slate-400">取消</button>
                                    <button onClick={handleAuthSubmit} className="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">解鎖</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
