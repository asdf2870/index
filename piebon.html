import React, { useState, useEffect, useMemo } from 'react';
import { 
  ChevronLeft, ChevronRight, Lock, Unlock, 
  Calendar, Clock, AlertCircle, UserPlus, X, Trash2, Edit3, Plus, Eye, EyeOff
} from 'lucide-react';
import { initializeApp } from "firebase/app";
import { getDatabase, ref, onValue, update } from "firebase/database";

// --- Firebase 配置 ---
const firebaseConfig = {
    apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
    authDomain: "order-718b1.firebaseapp.com",
    projectId: "order-718b1",
    storageBucket: "order-718b1.firebasestorage.app",
    messagingSenderId: "454465000018",
    appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
    databaseURL: "https://order-718b1-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

// 初始化 Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ADMIN_PASSCODE = "0418";

// 工具函數：解析時間計算時數
const parseShiftTime = (timeStr) => {
  if (!timeStr || typeof timeStr !== 'string') return { start: 0, end: 0, hours: 0 };
  const parts = timeStr.split('-');
  if (parts.length !== 2) return { start: 0, end: 0, hours: 0 };
  
  const toDec = (s) => {
    if (s.includes(':')) {
      const [h, m] = s.split(':').map(Number);
      return h + (m / 60);
    }
    return Number(s);
  };

  let start = toDec(parts[0]);
  let end = toDec(parts[1]);
  if (end < start) end += 24; 
  return { start, end, hours: end - start };
};

const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
const weekNames = ['一', '二', '三', '四', '五', '六', '日'];
const getWeekdayIndex = (year, month, day) => {
  let dayOfWeek = new Date(year, month, day).getDay(); 
  return dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
};

const App = () => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [view, setView] = useState('admin-view');
  const [isLocked, setIsLocked] = useState(true); 
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authPassword, setAuthPassword] = useState("");
  const [customTime, setCustomTime] = useState("");
  const [hideUnavail, setHideUnavail] = useState(false); 
  const [loading, setLoading] = useState(true);

  // 資料狀態
  const [staff, setStaff] = useState([]);
  const [unavailabilities, setUnavailabilities] = useState({});
  const [schedules, setSchedules] = useState({});

  const [popover, setPopover] = useState(null); 
  const [editingStaff, setEditingStaff] = useState(null);

  // 1. 監聽 Firebase 雲端資料同步
  useEffect(() => {
    const dataRef = ref(db, 'shift_system');
    const unsubscribe = onValue(dataRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        setStaff(data.staff || []);
        setUnavailabilities(data.unavailabilities || {});
        setSchedules(data.schedules || {});
      }
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. 統一雲端同步方法
  const syncToCloud = (newStaff, newUnavail, newSched) => {
    update(ref(db, 'shift_system'), {
      staff: newStaff,
      unavailabilities: newUnavail,
      schedules: newSched
    });
  };

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const daysCount = getDaysInMonth(year, month);
  const dates = Array.from({ length: daysCount }, (_, i) => i + 1);
  const sortedStaff = [...staff].sort((a, b) => (a.order || 99) - (b.order || 99));

  const statistics = useMemo(() => {
    const stats = {};
    sortedStaff.forEach(s => {
      let totalHours = 0;
      let scheduledDays = 0;
      dates.forEach(d => {
        const shift = schedules[`${s.id}-${d}`];
        if (shift) {
          totalHours += parseShiftTime(shift).hours;
          scheduledDays++;
        }
      });
      stats[s.id] = { hours: totalHours.toFixed(1), unscheduled: daysCount - scheduledDays };
    });
    return stats;
  }, [schedules, sortedStaff, daysCount]);

  const handleAuthSubmit = () => {
    if (authPassword === ADMIN_PASSCODE) {
      setIsLocked(false);
      setShowAuthModal(false);
      setAuthPassword("");
    } else { alert("密碼錯誤！"); }
  };

  const checkConflict = (staffId, date, shiftStr) => {
    if (!shiftStr) return false;
    const key = `${staffId}-${year}-${month}-${date}`;
    const unavail = unavailabilities[key];
    if (!unavail) return false;
    
    if (unavail.types?.includes('全天休')) return true;
    const { start, end } = parseShiftTime(shiftStr);

    if (unavail.types?.includes('早休')) { if (start < 16) return true; }
    if (unavail.types?.includes('晚休')) {
      if (start < 20 && end > 16) return true;
    }
    if (unavail.types?.includes('夜休')) { if (end > 23) return true; }
    if (unavail.canWorkUntil && end > Number(unavail.canWorkUntil)) return true;
    if (unavail.cannotWorkAfter && start < Number(unavail.cannotWorkAfter)) return true;
    
    return false;
  };

  const getUnavailDisplayData = (data) => {
    if (!data || hideUnavail) return null;
    let textParts = [];
    if (data.types?.includes('全天休')) return { text: '全休', bg: 'rgba(71, 85, 105, 0.9)', color: '#fff', isFull: true };
    if (data.types?.length > 0) {
      const typeMap = { '早休': '早', '晚休': '晚', '夜休': '夜' };
      textParts.push(data.types.map(t => typeMap[t] || t).join('/'));
    }
    if (data.canWorkUntil) textParts.push(`到${data.canWorkUntil}點`);
    if (data.cannotWorkAfter) textParts.push(`${data.cannotWorkAfter}點後可`);
    if (textParts.length === 0 && !data.note) return null;
    return { text: textParts.join('\n') || (data.note ? '有備註' : ''), bg: 'rgba(254, 226, 226, 0.6)', color: '#dc2626' };
  };

  const SHIFT_OPTIONS = {
    'morning': ['08-14', '08-16', '10-17', '10-16'],
    'evening': ['16-23', '17-23', '18-23', '12-20'],
    'night': ['23-05', '00-08']
  };

  if (loading) return <div className="h-screen flex items-center justify-center font-black text-slate-400 animate-pulse">排班資料同步中...</div>;

  return (
    <div className="min-h-screen bg-[#F8FAFC] font-sans text-slate-900 pb-20">
      {/* 這裡保留你原本所有的 JSX 介面內容，僅修改資料操作部分 */}
      {/* ... (省略重複的導航欄、表格、Modal JSX，這些都維持不變) ... */}
      
      {/* 關鍵：在所有修改資料的地方調用 syncToCloud */}
      {/* 例如在新增/編輯人員的儲存按鈕： */}
      {/* onClick={() => {
          const newStaff = staff.some(s => s.id === editingStaff.id) ? staff.map(s => s.id === editingStaff.id ? editingStaff : s) : [...staff, editingStaff];
          syncToCloud(newStaff, unavailabilities, schedules);
          setEditingStaff(null);
        }}
      */}

      {/* 或者是畫休存檔按鈕： */}
      {/* onClick={() => {
          syncToCloud(staff, unavailabilities, schedules);
          setPopover(null);
        }}
      */}

      {/* 為了保持響應式，建議在組件內的對應操作函數中直接觸發 syncToCloud */}
      
      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}} />
    </div>
  );
};

export default App;
